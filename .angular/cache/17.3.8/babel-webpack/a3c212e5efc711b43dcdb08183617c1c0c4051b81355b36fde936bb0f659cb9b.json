{"ast":null,"code":"import '@firebase/installations';\nimport { Component } from '@firebase/component';\nimport { ErrorFactory } from '@firebase/util';\nimport { __spreadArray, __read, __awaiter, __generator, __assign, __values } from 'tslib';\nimport { deleteDb, openDb } from 'idb';\nimport firebase from '@firebase/app';\n\n/**\r\n * @license\r\n * Copyright 2017 Google LLC\r\n *\r\n * Licensed under the Apache License, Version 2.0 (the \"License\");\r\n * you may not use this file except in compliance with the License.\r\n * You may obtain a copy of the License at\r\n *\r\n *   http://www.apache.org/licenses/LICENSE-2.0\r\n *\r\n * Unless required by applicable law or agreed to in writing, software\r\n * distributed under the License is distributed on an \"AS IS\" BASIS,\r\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\r\n * See the License for the specific language governing permissions and\r\n * limitations under the License.\r\n */\nvar _a;\nvar ERROR_MAP = (_a = {}, _a[\"missing-app-config-values\" /* MISSING_APP_CONFIG_VALUES */] = 'Missing App configuration value: \"{$valueName}\"', _a[\"only-available-in-window\" /* AVAILABLE_IN_WINDOW */] = 'This method is available in a Window context.', _a[\"only-available-in-sw\" /* AVAILABLE_IN_SW */] = 'This method is available in a service worker context.', _a[\"permission-default\" /* PERMISSION_DEFAULT */] = 'The notification permission was not granted and dismissed instead.', _a[\"permission-blocked\" /* PERMISSION_BLOCKED */] = 'The notification permission was not granted and blocked instead.', _a[\"unsupported-browser\" /* UNSUPPORTED_BROWSER */] = \"This browser doesn't support the API's required to use the firebase SDK.\", _a[\"failed-service-worker-registration\" /* FAILED_DEFAULT_REGISTRATION */] = 'We are unable to register the default service worker. {$browserErrorMessage}', _a[\"token-subscribe-failed\" /* TOKEN_SUBSCRIBE_FAILED */] = 'A problem occurred while subscribing the user to FCM: {$errorInfo}', _a[\"token-subscribe-no-token\" /* TOKEN_SUBSCRIBE_NO_TOKEN */] = 'FCM returned no token when subscribing the user to push.', _a[\"token-unsubscribe-failed\" /* TOKEN_UNSUBSCRIBE_FAILED */] = 'A problem occurred while unsubscribing the ' + 'user from FCM: {$errorInfo}', _a[\"token-update-failed\" /* TOKEN_UPDATE_FAILED */] = 'A problem occurred while updating the user from FCM: {$errorInfo}', _a[\"token-update-no-token\" /* TOKEN_UPDATE_NO_TOKEN */] = 'FCM returned no token when updating the user to push.', _a[\"use-sw-after-get-token\" /* USE_SW_AFTER_GET_TOKEN */] = 'The useServiceWorker() method may only be called once and must be ' + 'called before calling getToken() to ensure your service worker is used.', _a[\"invalid-sw-registration\" /* INVALID_SW_REGISTRATION */] = 'The input to useServiceWorker() must be a ServiceWorkerRegistration.', _a[\"invalid-bg-handler\" /* INVALID_BG_HANDLER */] = 'The input to setBackgroundMessageHandler() must be a function.', _a[\"invalid-vapid-key\" /* INVALID_VAPID_KEY */] = 'The public VAPID key must be a string.', _a[\"use-vapid-key-after-get-token\" /* USE_VAPID_KEY_AFTER_GET_TOKEN */] = 'The usePublicVapidKey() method may only be called once and must be ' + 'called before calling getToken() to ensure your VAPID key is used.', _a);\nvar ERROR_FACTORY = new ErrorFactory('messaging', 'Messaging', ERROR_MAP);\n\n/**\r\n * @license\r\n * Copyright 2019 Google LLC\r\n *\r\n * Licensed under the Apache License, Version 2.0 (the \"License\");\r\n * you may not use this file except in compliance with the License.\r\n * You may obtain a copy of the License at\r\n *\r\n *   http://www.apache.org/licenses/LICENSE-2.0\r\n *\r\n * Unless required by applicable law or agreed to in writing, software\r\n * distributed under the License is distributed on an \"AS IS\" BASIS,\r\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\r\n * See the License for the specific language governing permissions and\r\n * limitations under the License.\r\n */\nvar DEFAULT_SW_PATH = '/firebase-messaging-sw.js';\nvar DEFAULT_SW_SCOPE = '/firebase-cloud-messaging-push-scope';\nvar DEFAULT_VAPID_KEY = 'BDOU99-h67HcA6JeFXHbSNMu7e2yNNu3RzoMj8TM4W88jITfq7ZmPvIM1Iv-4_l2LxQcYwhqby2xGpWwzjfAnG4';\nvar ENDPOINT = 'https://fcmregistrations.googleapis.com/v1';\n// Key of FCM Payload in Notification's data field.\nvar FCM_MSG = 'FCM_MSG';\nvar TAG = 'FirebaseMessaging: ';\n// Set to '1' if Analytics is enabled for the campaign\nvar CONSOLE_CAMPAIGN_ANALYTICS_ENABLED = 'google.c.a.e';\nvar CONSOLE_CAMPAIGN_ID = 'google.c.a.c_id';\nvar CONSOLE_CAMPAIGN_TIME = 'google.c.a.ts';\nvar CONSOLE_CAMPAIGN_NAME = 'google.c.a.c_l';\n// Due to the fact that onBackgroundMessage can't be awaited (to support rxjs), a silent push\n// warning might be shown by the browser if the callback fails to completes by the end of onPush.\n// Experiments were ran to determine the majority onBackground message clock time. This brief\n// blocking time would allow majority of the onBackgroundMessage callback to finish.\nvar BACKGROUND_HANDLE_EXECUTION_TIME_LIMIT_MS = 1000;\n// Preparation time for client to initialize and set up the message handler.\nvar FOREGROUND_HANDLE_PREPARATION_TIME_MS = 3000;\n\n/**\r\n * @license\r\n * Copyright 2018 Google LLC\r\n *\r\n * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except\r\n * in compliance with the License. You may obtain a copy of the License at\r\n *\r\n * http://www.apache.org/licenses/LICENSE-2.0\r\n *\r\n * Unless required by applicable law or agreed to in writing, software distributed under the License\r\n * is distributed on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express\r\n * or implied. See the License for the specific language governing permissions and limitations under\r\n * the License.\r\n */\nvar MessageType;\n(function (MessageType) {\n  MessageType[\"PUSH_RECEIVED\"] = \"push-received\";\n  MessageType[\"NOTIFICATION_CLICKED\"] = \"notification-clicked\";\n})(MessageType || (MessageType = {}));\n\n/**\r\n * @license\r\n * Copyright 2017 Google LLC\r\n *\r\n * Licensed under the Apache License, Version 2.0 (the \"License\");\r\n * you may not use this file except in compliance with the License.\r\n * You may obtain a copy of the License at\r\n *\r\n *   http://www.apache.org/licenses/LICENSE-2.0\r\n *\r\n * Unless required by applicable law or agreed to in writing, software\r\n * distributed under the License is distributed on an \"AS IS\" BASIS,\r\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\r\n * See the License for the specific language governing permissions and\r\n * limitations under the License.\r\n */\nfunction arrayToBase64(array) {\n  var uint8Array = new Uint8Array(array);\n  var base64String = btoa(String.fromCharCode.apply(String, __spreadArray([], __read(uint8Array))));\n  return base64String.replace(/=/g, '').replace(/\\+/g, '-').replace(/\\//g, '_');\n}\nfunction base64ToArray(base64String) {\n  var padding = '='.repeat((4 - base64String.length % 4) % 4);\n  var base64 = (base64String + padding).replace(/\\-/g, '+').replace(/_/g, '/');\n  var rawData = atob(base64);\n  var outputArray = new Uint8Array(rawData.length);\n  for (var i = 0; i < rawData.length; ++i) {\n    outputArray[i] = rawData.charCodeAt(i);\n  }\n  return outputArray;\n}\n\n/**\r\n * @license\r\n * Copyright 2019 Google LLC\r\n *\r\n * Licensed under the Apache License, Version 2.0 (the \"License\");\r\n * you may not use this file except in compliance with the License.\r\n * You may obtain a copy of the License at\r\n *\r\n *   http://www.apache.org/licenses/LICENSE-2.0\r\n *\r\n * Unless required by applicable law or agreed to in writing, software\r\n * distributed under the License is distributed on an \"AS IS\" BASIS,\r\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\r\n * See the License for the specific language governing permissions and\r\n * limitations under the License.\r\n */\nvar OLD_DB_NAME = 'fcm_token_details_db';\n/**\r\n * The last DB version of 'fcm_token_details_db' was 4. This is one higher, so that the upgrade\r\n * callback is called for all versions of the old DB.\r\n */\nvar OLD_DB_VERSION = 5;\nvar OLD_OBJECT_STORE_NAME = 'fcm_token_object_Store';\nfunction migrateOldDatabase(senderId) {\n  return __awaiter(this, void 0, void 0, function () {\n    var databases, dbNames, tokenDetails, db;\n    var _this = this;\n    return __generator(this, function (_a) {\n      switch (_a.label) {\n        case 0:\n          if (!('databases' in indexedDB)) return [3 /*break*/, 2];\n          return [4 /*yield*/, indexedDB.databases()];\n        case 1:\n          databases = _a.sent();\n          dbNames = databases.map(function (db) {\n            return db.name;\n          });\n          if (!dbNames.includes(OLD_DB_NAME)) {\n            // old DB didn't exist, no need to open.\n            return [2 /*return*/, null];\n          }\n          _a.label = 2;\n        case 2:\n          tokenDetails = null;\n          return [4 /*yield*/, openDb(OLD_DB_NAME, OLD_DB_VERSION, function (db) {\n            return __awaiter(_this, void 0, void 0, function () {\n              var objectStore, value, oldDetails, oldDetails, oldDetails;\n              var _a;\n              return __generator(this, function (_b) {\n                switch (_b.label) {\n                  case 0:\n                    if (db.oldVersion < 2) {\n                      // Database too old, skip migration.\n                      return [2 /*return*/];\n                    }\n                    if (!db.objectStoreNames.contains(OLD_OBJECT_STORE_NAME)) {\n                      // Database did not exist. Nothing to do.\n                      return [2 /*return*/];\n                    }\n                    objectStore = db.transaction.objectStore(OLD_OBJECT_STORE_NAME);\n                    return [4 /*yield*/, objectStore.index('fcmSenderId').get(senderId)];\n                  case 1:\n                    value = _b.sent();\n                    return [4 /*yield*/, objectStore.clear()];\n                  case 2:\n                    _b.sent();\n                    if (!value) {\n                      // No entry in the database, nothing to migrate.\n                      return [2 /*return*/];\n                    }\n                    if (db.oldVersion === 2) {\n                      oldDetails = value;\n                      if (!oldDetails.auth || !oldDetails.p256dh || !oldDetails.endpoint) {\n                        return [2 /*return*/];\n                      }\n                      tokenDetails = {\n                        token: oldDetails.fcmToken,\n                        createTime: (_a = oldDetails.createTime) !== null && _a !== void 0 ? _a : Date.now(),\n                        subscriptionOptions: {\n                          auth: oldDetails.auth,\n                          p256dh: oldDetails.p256dh,\n                          endpoint: oldDetails.endpoint,\n                          swScope: oldDetails.swScope,\n                          vapidKey: typeof oldDetails.vapidKey === 'string' ? oldDetails.vapidKey : arrayToBase64(oldDetails.vapidKey)\n                        }\n                      };\n                    } else if (db.oldVersion === 3) {\n                      oldDetails = value;\n                      tokenDetails = {\n                        token: oldDetails.fcmToken,\n                        createTime: oldDetails.createTime,\n                        subscriptionOptions: {\n                          auth: arrayToBase64(oldDetails.auth),\n                          p256dh: arrayToBase64(oldDetails.p256dh),\n                          endpoint: oldDetails.endpoint,\n                          swScope: oldDetails.swScope,\n                          vapidKey: arrayToBase64(oldDetails.vapidKey)\n                        }\n                      };\n                    } else if (db.oldVersion === 4) {\n                      oldDetails = value;\n                      tokenDetails = {\n                        token: oldDetails.fcmToken,\n                        createTime: oldDetails.createTime,\n                        subscriptionOptions: {\n                          auth: arrayToBase64(oldDetails.auth),\n                          p256dh: arrayToBase64(oldDetails.p256dh),\n                          endpoint: oldDetails.endpoint,\n                          swScope: oldDetails.swScope,\n                          vapidKey: arrayToBase64(oldDetails.vapidKey)\n                        }\n                      };\n                    }\n                    return [2 /*return*/];\n                }\n              });\n            });\n          })];\n        case 3:\n          db = _a.sent();\n          db.close();\n          // Delete all old databases.\n          return [4 /*yield*/, deleteDb(OLD_DB_NAME)];\n        case 4:\n          // Delete all old databases.\n          _a.sent();\n          return [4 /*yield*/, deleteDb('fcm_vapid_details_db')];\n        case 5:\n          _a.sent();\n          return [4 /*yield*/, deleteDb('undefined')];\n        case 6:\n          _a.sent();\n          return [2 /*return*/, checkTokenDetails(tokenDetails) ? tokenDetails : null];\n      }\n    });\n  });\n}\nfunction checkTokenDetails(tokenDetails) {\n  if (!tokenDetails || !tokenDetails.subscriptionOptions) {\n    return false;\n  }\n  var subscriptionOptions = tokenDetails.subscriptionOptions;\n  return typeof tokenDetails.createTime === 'number' && tokenDetails.createTime > 0 && typeof tokenDetails.token === 'string' && tokenDetails.token.length > 0 && typeof subscriptionOptions.auth === 'string' && subscriptionOptions.auth.length > 0 && typeof subscriptionOptions.p256dh === 'string' && subscriptionOptions.p256dh.length > 0 && typeof subscriptionOptions.endpoint === 'string' && subscriptionOptions.endpoint.length > 0 && typeof subscriptionOptions.swScope === 'string' && subscriptionOptions.swScope.length > 0 && typeof subscriptionOptions.vapidKey === 'string' && subscriptionOptions.vapidKey.length > 0;\n}\n\n/**\r\n * @license\r\n * Copyright 2019 Google LLC\r\n *\r\n * Licensed under the Apache License, Version 2.0 (the \"License\");\r\n * you may not use this file except in compliance with the License.\r\n * You may obtain a copy of the License at\r\n *\r\n *   http://www.apache.org/licenses/LICENSE-2.0\r\n *\r\n * Unless required by applicable law or agreed to in writing, software\r\n * distributed under the License is distributed on an \"AS IS\" BASIS,\r\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\r\n * See the License for the specific language governing permissions and\r\n * limitations under the License.\r\n */\n// Exported for tests.\nvar DATABASE_NAME = 'firebase-messaging-database';\nvar DATABASE_VERSION = 1;\nvar OBJECT_STORE_NAME = 'firebase-messaging-store';\nvar dbPromise = null;\nfunction getDbPromise() {\n  if (!dbPromise) {\n    dbPromise = openDb(DATABASE_NAME, DATABASE_VERSION, function (upgradeDb) {\n      // We don't use 'break' in this switch statement, the fall-through behavior is what we want,\n      // because if there are multiple versions between the old version and the current version, we\n      // want ALL the migrations that correspond to those versions to run, not only the last one.\n      // eslint-disable-next-line default-case\n      switch (upgradeDb.oldVersion) {\n        case 0:\n          upgradeDb.createObjectStore(OBJECT_STORE_NAME);\n      }\n    });\n  }\n  return dbPromise;\n}\n/** Gets record(s) from the objectStore that match the given key. */\nfunction dbGet(firebaseDependencies) {\n  return __awaiter(this, void 0, void 0, function () {\n    var key, db, tokenDetails, oldTokenDetails;\n    return __generator(this, function (_a) {\n      switch (_a.label) {\n        case 0:\n          key = getKey(firebaseDependencies);\n          return [4 /*yield*/, getDbPromise()];\n        case 1:\n          db = _a.sent();\n          return [4 /*yield*/, db.transaction(OBJECT_STORE_NAME).objectStore(OBJECT_STORE_NAME).get(key)];\n        case 2:\n          tokenDetails = _a.sent();\n          if (!tokenDetails) return [3 /*break*/, 3];\n          return [2 /*return*/, tokenDetails];\n        case 3:\n          return [4 /*yield*/, migrateOldDatabase(firebaseDependencies.appConfig.senderId)];\n        case 4:\n          oldTokenDetails = _a.sent();\n          if (!oldTokenDetails) return [3 /*break*/, 6];\n          return [4 /*yield*/, dbSet(firebaseDependencies, oldTokenDetails)];\n        case 5:\n          _a.sent();\n          return [2 /*return*/, oldTokenDetails];\n        case 6:\n          return [2 /*return*/];\n      }\n    });\n  });\n}\n/** Assigns or overwrites the record for the given key with the given value. */\nfunction dbSet(firebaseDependencies, tokenDetails) {\n  return __awaiter(this, void 0, void 0, function () {\n    var key, db, tx;\n    return __generator(this, function (_a) {\n      switch (_a.label) {\n        case 0:\n          key = getKey(firebaseDependencies);\n          return [4 /*yield*/, getDbPromise()];\n        case 1:\n          db = _a.sent();\n          tx = db.transaction(OBJECT_STORE_NAME, 'readwrite');\n          return [4 /*yield*/, tx.objectStore(OBJECT_STORE_NAME).put(tokenDetails, key)];\n        case 2:\n          _a.sent();\n          return [4 /*yield*/, tx.complete];\n        case 3:\n          _a.sent();\n          return [2 /*return*/, tokenDetails];\n      }\n    });\n  });\n}\n/** Removes record(s) from the objectStore that match the given key. */\nfunction dbRemove(firebaseDependencies) {\n  return __awaiter(this, void 0, void 0, function () {\n    var key, db, tx;\n    return __generator(this, function (_a) {\n      switch (_a.label) {\n        case 0:\n          key = getKey(firebaseDependencies);\n          return [4 /*yield*/, getDbPromise()];\n        case 1:\n          db = _a.sent();\n          tx = db.transaction(OBJECT_STORE_NAME, 'readwrite');\n          return [4 /*yield*/, tx.objectStore(OBJECT_STORE_NAME).delete(key)];\n        case 2:\n          _a.sent();\n          return [4 /*yield*/, tx.complete];\n        case 3:\n          _a.sent();\n          return [2 /*return*/];\n      }\n    });\n  });\n}\nfunction getKey(_a) {\n  var appConfig = _a.appConfig;\n  return appConfig.appId;\n}\n\n/**\r\n * @license\r\n * Copyright 2019 Google LLC\r\n *\r\n * Licensed under the Apache License, Version 2.0 (the \"License\");\r\n * you may not use this file except in compliance with the License.\r\n * You may obtain a copy of the License at\r\n *\r\n *   http://www.apache.org/licenses/LICENSE-2.0\r\n *\r\n * Unless required by applicable law or agreed to in writing, software\r\n * distributed under the License is distributed on an \"AS IS\" BASIS,\r\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\r\n * See the License for the specific language governing permissions and\r\n * limitations under the License.\r\n */\nfunction requestGetToken(firebaseDependencies, subscriptionOptions) {\n  return __awaiter(this, void 0, void 0, function () {\n    var headers, body, subscribeOptions, responseData, response, err_1, message;\n    return __generator(this, function (_a) {\n      switch (_a.label) {\n        case 0:\n          return [4 /*yield*/, getHeaders(firebaseDependencies)];\n        case 1:\n          headers = _a.sent();\n          body = getBody(subscriptionOptions);\n          subscribeOptions = {\n            method: 'POST',\n            headers: headers,\n            body: JSON.stringify(body)\n          };\n          _a.label = 2;\n        case 2:\n          _a.trys.push([2, 5,, 6]);\n          return [4 /*yield*/, fetch(getEndpoint(firebaseDependencies.appConfig), subscribeOptions)];\n        case 3:\n          response = _a.sent();\n          return [4 /*yield*/, response.json()];\n        case 4:\n          responseData = _a.sent();\n          return [3 /*break*/, 6];\n        case 5:\n          err_1 = _a.sent();\n          throw ERROR_FACTORY.create(\"token-subscribe-failed\" /* TOKEN_SUBSCRIBE_FAILED */, {\n            errorInfo: err_1\n          });\n        case 6:\n          if (responseData.error) {\n            message = responseData.error.message;\n            throw ERROR_FACTORY.create(\"token-subscribe-failed\" /* TOKEN_SUBSCRIBE_FAILED */, {\n              errorInfo: message\n            });\n          }\n          if (!responseData.token) {\n            throw ERROR_FACTORY.create(\"token-subscribe-no-token\" /* TOKEN_SUBSCRIBE_NO_TOKEN */);\n          }\n          return [2 /*return*/, responseData.token];\n      }\n    });\n  });\n}\nfunction requestUpdateToken(firebaseDependencies, tokenDetails) {\n  return __awaiter(this, void 0, void 0, function () {\n    var headers, body, updateOptions, responseData, response, err_2, message;\n    return __generator(this, function (_a) {\n      switch (_a.label) {\n        case 0:\n          return [4 /*yield*/, getHeaders(firebaseDependencies)];\n        case 1:\n          headers = _a.sent();\n          body = getBody(tokenDetails.subscriptionOptions);\n          updateOptions = {\n            method: 'PATCH',\n            headers: headers,\n            body: JSON.stringify(body)\n          };\n          _a.label = 2;\n        case 2:\n          _a.trys.push([2, 5,, 6]);\n          return [4 /*yield*/, fetch(getEndpoint(firebaseDependencies.appConfig) + \"/\" + tokenDetails.token, updateOptions)];\n        case 3:\n          response = _a.sent();\n          return [4 /*yield*/, response.json()];\n        case 4:\n          responseData = _a.sent();\n          return [3 /*break*/, 6];\n        case 5:\n          err_2 = _a.sent();\n          throw ERROR_FACTORY.create(\"token-update-failed\" /* TOKEN_UPDATE_FAILED */, {\n            errorInfo: err_2\n          });\n        case 6:\n          if (responseData.error) {\n            message = responseData.error.message;\n            throw ERROR_FACTORY.create(\"token-update-failed\" /* TOKEN_UPDATE_FAILED */, {\n              errorInfo: message\n            });\n          }\n          if (!responseData.token) {\n            throw ERROR_FACTORY.create(\"token-update-no-token\" /* TOKEN_UPDATE_NO_TOKEN */);\n          }\n          return [2 /*return*/, responseData.token];\n      }\n    });\n  });\n}\nfunction requestDeleteToken(firebaseDependencies, token) {\n  return __awaiter(this, void 0, void 0, function () {\n    var headers, unsubscribeOptions, response, responseData, message, err_3;\n    return __generator(this, function (_a) {\n      switch (_a.label) {\n        case 0:\n          return [4 /*yield*/, getHeaders(firebaseDependencies)];\n        case 1:\n          headers = _a.sent();\n          unsubscribeOptions = {\n            method: 'DELETE',\n            headers: headers\n          };\n          _a.label = 2;\n        case 2:\n          _a.trys.push([2, 5,, 6]);\n          return [4 /*yield*/, fetch(getEndpoint(firebaseDependencies.appConfig) + \"/\" + token, unsubscribeOptions)];\n        case 3:\n          response = _a.sent();\n          return [4 /*yield*/, response.json()];\n        case 4:\n          responseData = _a.sent();\n          if (responseData.error) {\n            message = responseData.error.message;\n            throw ERROR_FACTORY.create(\"token-unsubscribe-failed\" /* TOKEN_UNSUBSCRIBE_FAILED */, {\n              errorInfo: message\n            });\n          }\n          return [3 /*break*/, 6];\n        case 5:\n          err_3 = _a.sent();\n          throw ERROR_FACTORY.create(\"token-unsubscribe-failed\" /* TOKEN_UNSUBSCRIBE_FAILED */, {\n            errorInfo: err_3\n          });\n        case 6:\n          return [2 /*return*/];\n      }\n    });\n  });\n}\nfunction getEndpoint(_a) {\n  var projectId = _a.projectId;\n  return ENDPOINT + \"/projects/\" + projectId + \"/registrations\";\n}\nfunction getHeaders(_a) {\n  var appConfig = _a.appConfig,\n    installations = _a.installations;\n  return __awaiter(this, void 0, void 0, function () {\n    var authToken;\n    return __generator(this, function (_b) {\n      switch (_b.label) {\n        case 0:\n          return [4 /*yield*/, installations.getToken()];\n        case 1:\n          authToken = _b.sent();\n          return [2 /*return*/, new Headers({\n            'Content-Type': 'application/json',\n            Accept: 'application/json',\n            'x-goog-api-key': appConfig.apiKey,\n            'x-goog-firebase-installations-auth': \"FIS \" + authToken\n          })];\n      }\n    });\n  });\n}\nfunction getBody(_a) {\n  var p256dh = _a.p256dh,\n    auth = _a.auth,\n    endpoint = _a.endpoint,\n    vapidKey = _a.vapidKey;\n  var body = {\n    web: {\n      endpoint: endpoint,\n      auth: auth,\n      p256dh: p256dh\n    }\n  };\n  if (vapidKey !== DEFAULT_VAPID_KEY) {\n    body.web.applicationPubKey = vapidKey;\n  }\n  return body;\n}\n\n/**\r\n * @license\r\n * Copyright 2019 Google LLC\r\n *\r\n * Licensed under the Apache License, Version 2.0 (the \"License\");\r\n * you may not use this file except in compliance with the License.\r\n * You may obtain a copy of the License at\r\n *\r\n *   http://www.apache.org/licenses/LICENSE-2.0\r\n *\r\n * Unless required by applicable law or agreed to in writing, software\r\n * distributed under the License is distributed on an \"AS IS\" BASIS,\r\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\r\n * See the License for the specific language governing permissions and\r\n * limitations under the License.\r\n */\n/** UpdateRegistration will be called once every week. */\nvar TOKEN_EXPIRATION_MS = 7 * 24 * 60 * 60 * 1000; // 7 days\nfunction getToken(firebaseDependencies, swRegistration, vapidKey) {\n  return __awaiter(this, void 0, void 0, function () {\n    var pushSubscription, tokenDetails, subscriptionOptions, e_1;\n    return __generator(this, function (_a) {\n      switch (_a.label) {\n        case 0:\n          if (Notification.permission !== 'granted') {\n            throw ERROR_FACTORY.create(\"permission-blocked\" /* PERMISSION_BLOCKED */);\n          }\n          return [4 /*yield*/, getPushSubscription(swRegistration, vapidKey)];\n        case 1:\n          pushSubscription = _a.sent();\n          return [4 /*yield*/, dbGet(firebaseDependencies)];\n        case 2:\n          tokenDetails = _a.sent();\n          subscriptionOptions = {\n            vapidKey: vapidKey,\n            swScope: swRegistration.scope,\n            endpoint: pushSubscription.endpoint,\n            auth: arrayToBase64(pushSubscription.getKey('auth')),\n            p256dh: arrayToBase64(pushSubscription.getKey('p256dh'))\n          };\n          if (!!tokenDetails) return [3 /*break*/, 3];\n          // No token, get a new one.\n          return [2 /*return*/, getNewToken(firebaseDependencies, subscriptionOptions)];\n        case 3:\n          if (!!isTokenValid(tokenDetails.subscriptionOptions, subscriptionOptions)) return [3 /*break*/, 8];\n          _a.label = 4;\n        case 4:\n          _a.trys.push([4, 6,, 7]);\n          return [4 /*yield*/, requestDeleteToken(firebaseDependencies, tokenDetails.token)];\n        case 5:\n          _a.sent();\n          return [3 /*break*/, 7];\n        case 6:\n          e_1 = _a.sent();\n          // Suppress errors because of #2364\n          console.warn(e_1);\n          return [3 /*break*/, 7];\n        case 7:\n          return [2 /*return*/, getNewToken(firebaseDependencies, subscriptionOptions)];\n        case 8:\n          if (Date.now() >= tokenDetails.createTime + TOKEN_EXPIRATION_MS) {\n            // Weekly token refresh\n            return [2 /*return*/, updateToken({\n              token: tokenDetails.token,\n              createTime: Date.now(),\n              subscriptionOptions: subscriptionOptions\n            }, firebaseDependencies, swRegistration)];\n          } else {\n            // Valid token, nothing to do.\n            return [2 /*return*/, tokenDetails.token];\n          }\n        case 9:\n          return [2 /*return*/];\n      }\n    });\n  });\n}\n/**\r\n * This method deletes the token from the database, unsubscribes the token from FCM, and unregisters\r\n * the push subscription if it exists.\r\n */\nfunction deleteToken(firebaseDependencies, swRegistration) {\n  return __awaiter(this, void 0, void 0, function () {\n    var tokenDetails, pushSubscription;\n    return __generator(this, function (_a) {\n      switch (_a.label) {\n        case 0:\n          return [4 /*yield*/, dbGet(firebaseDependencies)];\n        case 1:\n          tokenDetails = _a.sent();\n          if (!tokenDetails) return [3 /*break*/, 4];\n          return [4 /*yield*/, requestDeleteToken(firebaseDependencies, tokenDetails.token)];\n        case 2:\n          _a.sent();\n          return [4 /*yield*/, dbRemove(firebaseDependencies)];\n        case 3:\n          _a.sent();\n          _a.label = 4;\n        case 4:\n          return [4 /*yield*/, swRegistration.pushManager.getSubscription()];\n        case 5:\n          pushSubscription = _a.sent();\n          if (pushSubscription) {\n            return [2 /*return*/, pushSubscription.unsubscribe()];\n          }\n          // If there's no SW, consider it a success.\n          return [2 /*return*/, true];\n      }\n    });\n  });\n}\nfunction updateToken(tokenDetails, firebaseDependencies, swRegistration) {\n  return __awaiter(this, void 0, void 0, function () {\n    var updatedToken, updatedTokenDetails, e_2;\n    return __generator(this, function (_a) {\n      switch (_a.label) {\n        case 0:\n          _a.trys.push([0, 3,, 5]);\n          return [4 /*yield*/, requestUpdateToken(firebaseDependencies, tokenDetails)];\n        case 1:\n          updatedToken = _a.sent();\n          updatedTokenDetails = __assign(__assign({}, tokenDetails), {\n            token: updatedToken,\n            createTime: Date.now()\n          });\n          return [4 /*yield*/, dbSet(firebaseDependencies, updatedTokenDetails)];\n        case 2:\n          _a.sent();\n          return [2 /*return*/, updatedToken];\n        case 3:\n          e_2 = _a.sent();\n          return [4 /*yield*/, deleteToken(firebaseDependencies, swRegistration)];\n        case 4:\n          _a.sent();\n          throw e_2;\n        case 5:\n          return [2 /*return*/];\n      }\n    });\n  });\n}\nfunction getNewToken(firebaseDependencies, subscriptionOptions) {\n  return __awaiter(this, void 0, void 0, function () {\n    var token, tokenDetails;\n    return __generator(this, function (_a) {\n      switch (_a.label) {\n        case 0:\n          return [4 /*yield*/, requestGetToken(firebaseDependencies, subscriptionOptions)];\n        case 1:\n          token = _a.sent();\n          tokenDetails = {\n            token: token,\n            createTime: Date.now(),\n            subscriptionOptions: subscriptionOptions\n          };\n          return [4 /*yield*/, dbSet(firebaseDependencies, tokenDetails)];\n        case 2:\n          _a.sent();\n          return [2 /*return*/, tokenDetails.token];\n      }\n    });\n  });\n}\n/**\r\n * Gets a PushSubscription for the current user.\r\n */\nfunction getPushSubscription(swRegistration, vapidKey) {\n  return __awaiter(this, void 0, void 0, function () {\n    var subscription;\n    return __generator(this, function (_a) {\n      switch (_a.label) {\n        case 0:\n          return [4 /*yield*/, swRegistration.pushManager.getSubscription()];\n        case 1:\n          subscription = _a.sent();\n          if (subscription) {\n            return [2 /*return*/, subscription];\n          }\n          return [2 /*return*/, swRegistration.pushManager.subscribe({\n            userVisibleOnly: true,\n            // Chrome <= 75 doesn't support base64-encoded VAPID key. For backward compatibility, VAPID key\n            // submitted to pushManager#subscribe must be of type Uint8Array.\n            applicationServerKey: base64ToArray(vapidKey)\n          })];\n      }\n    });\n  });\n}\n/**\r\n * Checks if the saved tokenDetails object matches the configuration provided.\r\n */\nfunction isTokenValid(dbOptions, currentOptions) {\n  var isVapidKeyEqual = currentOptions.vapidKey === dbOptions.vapidKey;\n  var isEndpointEqual = currentOptions.endpoint === dbOptions.endpoint;\n  var isAuthEqual = currentOptions.auth === dbOptions.auth;\n  var isP256dhEqual = currentOptions.p256dh === dbOptions.p256dh;\n  return isVapidKeyEqual && isEndpointEqual && isAuthEqual && isP256dhEqual;\n}\n\n/**\r\n * @license\r\n * Copyright 2020 Google LLC\r\n *\r\n * Licensed under the Apache License, Version 2.0 (the \"License\");\r\n * you may not use this file except in compliance with the License.\r\n * You may obtain a copy of the License at\r\n *\r\n *   http://www.apache.org/licenses/LICENSE-2.0\r\n *\r\n * Unless required by applicable law or agreed to in writing, software\r\n * distributed under the License is distributed on an \"AS IS\" BASIS,\r\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\r\n * See the License for the specific language governing permissions and\r\n * limitations under the License.\r\n */\nfunction externalizePayload(internalPayload) {\n  var payload = {\n    from: internalPayload.from,\n    // eslint-disable-next-line camelcase\n    collapseKey: internalPayload.collapse_key,\n    // eslint-disable-next-line camelcase\n    messageId: internalPayload.fcm_message_id\n  };\n  propagateNotificationPayload(payload, internalPayload);\n  propagateDataPayload(payload, internalPayload);\n  propagateFcmOptions(payload, internalPayload);\n  return payload;\n}\nfunction propagateNotificationPayload(payload, messagePayloadInternal) {\n  if (!messagePayloadInternal.notification) {\n    return;\n  }\n  payload.notification = {};\n  var title = messagePayloadInternal.notification.title;\n  if (!!title) {\n    payload.notification.title = title;\n  }\n  var body = messagePayloadInternal.notification.body;\n  if (!!body) {\n    payload.notification.body = body;\n  }\n  var image = messagePayloadInternal.notification.image;\n  if (!!image) {\n    payload.notification.image = image;\n  }\n}\nfunction propagateDataPayload(payload, messagePayloadInternal) {\n  if (!messagePayloadInternal.data) {\n    return;\n  }\n  payload.data = messagePayloadInternal.data;\n}\nfunction propagateFcmOptions(payload, messagePayloadInternal) {\n  if (!messagePayloadInternal.fcmOptions) {\n    return;\n  }\n  payload.fcmOptions = {};\n  var link = messagePayloadInternal.fcmOptions.link;\n  if (!!link) {\n    payload.fcmOptions.link = link;\n  }\n  // eslint-disable-next-line camelcase\n  var analyticsLabel = messagePayloadInternal.fcmOptions.analytics_label;\n  if (!!analyticsLabel) {\n    payload.fcmOptions.analyticsLabel = analyticsLabel;\n  }\n}\n\n/**\r\n * @license\r\n * Copyright 2019 Google LLC\r\n *\r\n * Licensed under the Apache License, Version 2.0 (the \"License\");\r\n * you may not use this file except in compliance with the License.\r\n * You may obtain a copy of the License at\r\n *\r\n *   http://www.apache.org/licenses/LICENSE-2.0\r\n *\r\n * Unless required by applicable law or agreed to in writing, software\r\n * distributed under the License is distributed on an \"AS IS\" BASIS,\r\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\r\n * See the License for the specific language governing permissions and\r\n * limitations under the License.\r\n */\nfunction isConsoleMessage(data) {\n  // This message has a campaign ID, meaning it was sent using the Firebase Console.\n  return typeof data === 'object' && !!data && CONSOLE_CAMPAIGN_ID in data;\n}\n\n/**\r\n * @license\r\n * Copyright 2019 Google LLC\r\n *\r\n * Licensed under the Apache License, Version 2.0 (the \"License\");\r\n * you may not use this file except in compliance with the License.\r\n * You may obtain a copy of the License at\r\n *\r\n *   http://www.apache.org/licenses/LICENSE-2.0\r\n *\r\n * Unless required by applicable law or agreed to in writing, software\r\n * distributed under the License is distributed on an \"AS IS\" BASIS,\r\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\r\n * See the License for the specific language governing permissions and\r\n * limitations under the License.\r\n */\n/** Returns a promise that resolves after given time passes. */\nfunction sleep(ms) {\n  return new Promise(function (resolve) {\n    setTimeout(resolve, ms);\n  });\n}\n\n/**\r\n * @license\r\n * Copyright 2017 Google LLC\r\n *\r\n * Licensed under the Apache License, Version 2.0 (the \"License\");\r\n * you may not use this file except in compliance with the License.\r\n * You may obtain a copy of the License at\r\n *\r\n *   http://www.apache.org/licenses/LICENSE-2.0\r\n *\r\n * Unless required by applicable law or agreed to in writing, software\r\n * distributed under the License is distributed on an \"AS IS\" BASIS,\r\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\r\n * See the License for the specific language governing permissions and\r\n * limitations under the License.\r\n */\nvar SwController = /** @class */function () {\n  function SwController(firebaseDependencies) {\n    var _this = this;\n    this.firebaseDependencies = firebaseDependencies;\n    // A boolean flag to determine wether an app is using onBackgroundMessage or\n    // setBackgroundMessageHandler. onBackgroundMessage will receive a MessagePayload regardless of if\n    // a notification is displayed. Whereas, setBackgroundMessageHandler will swallow the\n    // MessagePayload if a NotificationPayload is included.\n    this.isOnBackgroundMessageUsed = null;\n    this.vapidKey = null;\n    this.bgMessageHandler = null;\n    self.addEventListener('push', function (e) {\n      e.waitUntil(_this.onPush(e));\n    });\n    self.addEventListener('pushsubscriptionchange', function (e) {\n      e.waitUntil(_this.onSubChange(e));\n    });\n    self.addEventListener('notificationclick', function (e) {\n      e.waitUntil(_this.onNotificationClick(e));\n    });\n  }\n  Object.defineProperty(SwController.prototype, \"app\", {\n    get: function () {\n      return this.firebaseDependencies.app;\n    },\n    enumerable: false,\n    configurable: true\n  });\n  /**\r\n   * @deprecated. Use onBackgroundMessage(nextOrObserver: NextFn<object> | Observer<object>):\r\n   * Unsubscribe instead.\r\n   *\r\n   * Calling setBackgroundMessageHandler will opt in to some specific behaviors.\r\n   *\r\n   * 1.) If a notification doesn't need to be shown due to a window already being visible, then push\r\n   * messages will be sent to the page. 2.) If a notification needs to be shown, and the message\r\n   * contains no notification data this method will be called and the promise it returns will be\r\n   * passed to event.waitUntil. If you do not set this callback then all push messages will let and\r\n   * the developer can handle them in a their own 'push' event callback\r\n   *\r\n   * @param callback The callback to be called when a push message is received and a notification\r\n   * must be shown. The callback will be given the data from the push message.\r\n   */\n  SwController.prototype.setBackgroundMessageHandler = function (callback) {\n    this.isOnBackgroundMessageUsed = false;\n    if (!callback || typeof callback !== 'function') {\n      throw ERROR_FACTORY.create(\"invalid-bg-handler\" /* INVALID_BG_HANDLER */);\n    }\n    this.bgMessageHandler = callback;\n  };\n  SwController.prototype.onBackgroundMessage = function (nextOrObserver) {\n    var _this = this;\n    this.isOnBackgroundMessageUsed = true;\n    this.bgMessageHandler = nextOrObserver;\n    return function () {\n      _this.bgMessageHandler = null;\n    };\n  };\n  // TODO: Remove getToken from SW Controller. Calling this from an old SW can cause all kinds of\n  // trouble.\n  SwController.prototype.getToken = function () {\n    var _a, _b;\n    return __awaiter(this, void 0, void 0, function () {\n      var tokenDetails;\n      return __generator(this, function (_c) {\n        switch (_c.label) {\n          case 0:\n            if (!!this.vapidKey) return [3 /*break*/, 2];\n            return [4 /*yield*/, dbGet(this.firebaseDependencies)];\n          case 1:\n            tokenDetails = _c.sent();\n            this.vapidKey = (_b = (_a = tokenDetails === null || tokenDetails === void 0 ? void 0 : tokenDetails.subscriptionOptions) === null || _a === void 0 ? void 0 : _a.vapidKey) !== null && _b !== void 0 ? _b : DEFAULT_VAPID_KEY;\n            _c.label = 2;\n          case 2:\n            return [2 /*return*/, getToken(this.firebaseDependencies, self.registration, this.vapidKey)];\n        }\n      });\n    });\n  };\n  // TODO: Remove deleteToken from SW Controller. Calling this from an old SW can cause all kinds of\n  // trouble.\n  SwController.prototype.deleteToken = function () {\n    return deleteToken(this.firebaseDependencies, self.registration);\n  };\n  SwController.prototype.requestPermission = function () {\n    throw ERROR_FACTORY.create(\"only-available-in-window\" /* AVAILABLE_IN_WINDOW */);\n  };\n  // TODO: Remove this together with getToken from SW Controller.\n  SwController.prototype.usePublicVapidKey = function (vapidKey) {\n    if (this.vapidKey !== null) {\n      throw ERROR_FACTORY.create(\"use-vapid-key-after-get-token\" /* USE_VAPID_KEY_AFTER_GET_TOKEN */);\n    }\n    if (typeof vapidKey !== 'string' || vapidKey.length === 0) {\n      throw ERROR_FACTORY.create(\"invalid-vapid-key\" /* INVALID_VAPID_KEY */);\n    }\n    this.vapidKey = vapidKey;\n  };\n  SwController.prototype.useServiceWorker = function () {\n    throw ERROR_FACTORY.create(\"only-available-in-window\" /* AVAILABLE_IN_WINDOW */);\n  };\n  SwController.prototype.onMessage = function () {\n    throw ERROR_FACTORY.create(\"only-available-in-window\" /* AVAILABLE_IN_WINDOW */);\n  };\n  SwController.prototype.onTokenRefresh = function () {\n    throw ERROR_FACTORY.create(\"only-available-in-window\" /* AVAILABLE_IN_WINDOW */);\n  };\n  /**\r\n   * A handler for push events that shows notifications based on the content of the payload.\r\n   *\r\n   * The payload must be a JSON-encoded Object with a `notification` key. The value of the\r\n   * `notification` property will be used as the NotificationOptions object passed to\r\n   * showNotification. Additionally, the `title` property of the notification object will be used as\r\n   * the title.\r\n   *\r\n   * If there is no notification data in the payload then no notification will be shown.\r\n   */\n  SwController.prototype.onPush = function (event) {\n    return __awaiter(this, void 0, void 0, function () {\n      var internalPayload, clientList, isNotificationShown, payload;\n      return __generator(this, function (_a) {\n        switch (_a.label) {\n          case 0:\n            internalPayload = getMessagePayloadInternal(event);\n            if (!internalPayload) {\n              console.debug(TAG + 'failed to get parsed MessagePayload from the PushEvent. Skip handling the push.');\n              return [2 /*return*/];\n            }\n            return [4 /*yield*/, getClientList()];\n          case 1:\n            clientList = _a.sent();\n            if (hasVisibleClients(clientList)) {\n              return [2 /*return*/, sendMessagePayloadInternalToWindows(clientList, internalPayload)];\n            }\n            isNotificationShown = false;\n            if (!!!internalPayload.notification) return [3 /*break*/, 3];\n            return [4 /*yield*/, showNotification(wrapInternalPayload(internalPayload))];\n          case 2:\n            _a.sent();\n            isNotificationShown = true;\n            _a.label = 3;\n          case 3:\n            // MessagePayload is only passed to `onBackgroundMessage`. Skip passing MessagePayload for\n            // the legacy `setBackgroundMessageHandler` to preserve the SDK behaviors.\n            if (isNotificationShown === true && this.isOnBackgroundMessageUsed === false) {\n              return [2 /*return*/];\n            }\n            if (!!this.bgMessageHandler) {\n              payload = externalizePayload(internalPayload);\n              if (typeof this.bgMessageHandler === 'function') {\n                this.bgMessageHandler(payload);\n              } else {\n                this.bgMessageHandler.next(payload);\n              }\n            }\n            // wait briefly to allow onBackgroundMessage to complete\n            return [4 /*yield*/, sleep(BACKGROUND_HANDLE_EXECUTION_TIME_LIMIT_MS)];\n          case 4:\n            // wait briefly to allow onBackgroundMessage to complete\n            _a.sent();\n            return [2 /*return*/];\n        }\n      });\n    });\n  };\n  SwController.prototype.onSubChange = function (event) {\n    var _a, _b;\n    return __awaiter(this, void 0, void 0, function () {\n      var newSubscription, tokenDetails;\n      return __generator(this, function (_c) {\n        switch (_c.label) {\n          case 0:\n            newSubscription = event.newSubscription;\n            if (!!newSubscription) return [3 /*break*/, 2];\n            // Subscription revoked, delete token\n            return [4 /*yield*/, deleteToken(this.firebaseDependencies, self.registration)];\n          case 1:\n            // Subscription revoked, delete token\n            _c.sent();\n            return [2 /*return*/];\n          case 2:\n            return [4 /*yield*/, dbGet(this.firebaseDependencies)];\n          case 3:\n            tokenDetails = _c.sent();\n            return [4 /*yield*/, deleteToken(this.firebaseDependencies, self.registration)];\n          case 4:\n            _c.sent();\n            return [4 /*yield*/, getToken(this.firebaseDependencies, self.registration, (_b = (_a = tokenDetails === null || tokenDetails === void 0 ? void 0 : tokenDetails.subscriptionOptions) === null || _a === void 0 ? void 0 : _a.vapidKey) !== null && _b !== void 0 ? _b : DEFAULT_VAPID_KEY)];\n          case 5:\n            _c.sent();\n            return [2 /*return*/];\n        }\n      });\n    });\n  };\n  SwController.prototype.onNotificationClick = function (event) {\n    var _a, _b;\n    return __awaiter(this, void 0, void 0, function () {\n      var internalPayload, link, url, originUrl, client;\n      return __generator(this, function (_c) {\n        switch (_c.label) {\n          case 0:\n            internalPayload = (_b = (_a = event.notification) === null || _a === void 0 ? void 0 : _a.data) === null || _b === void 0 ? void 0 : _b[FCM_MSG];\n            if (!internalPayload) {\n              return [2 /*return*/];\n            } else if (event.action) {\n              // User clicked on an action button. This will allow developers to act on action button clicks\n              // by using a custom onNotificationClick listener that they define.\n              return [2 /*return*/];\n            }\n            // Prevent other listeners from receiving the event\n            event.stopImmediatePropagation();\n            event.notification.close();\n            link = getLink(internalPayload);\n            if (!link) {\n              return [2 /*return*/];\n            }\n            url = new URL(link, self.location.href);\n            originUrl = new URL(self.location.origin);\n            if (url.host !== originUrl.host) {\n              return [2 /*return*/];\n            }\n            return [4 /*yield*/, getWindowClient(url)];\n          case 1:\n            client = _c.sent();\n            if (!!client) return [3 /*break*/, 4];\n            return [4 /*yield*/, self.clients.openWindow(link)];\n          case 2:\n            client = _c.sent();\n            // Wait three seconds for the client to initialize and set up the message handler so that it\n            // can receive the message.\n            return [4 /*yield*/, sleep(FOREGROUND_HANDLE_PREPARATION_TIME_MS)];\n          case 3:\n            // Wait three seconds for the client to initialize and set up the message handler so that it\n            // can receive the message.\n            _c.sent();\n            return [3 /*break*/, 6];\n          case 4:\n            return [4 /*yield*/, client.focus()];\n          case 5:\n            client = _c.sent();\n            _c.label = 6;\n          case 6:\n            if (!client) {\n              // Window Client will not be returned if it's for a third party origin.\n              return [2 /*return*/];\n            }\n            internalPayload.messageType = MessageType.NOTIFICATION_CLICKED;\n            internalPayload.isFirebaseMessaging = true;\n            return [2 /*return*/, client.postMessage(internalPayload)];\n        }\n      });\n    });\n  };\n  return SwController;\n}();\nfunction wrapInternalPayload(internalPayload) {\n  var _a;\n  var wrappedInternalPayload = __assign({}, internalPayload.notification);\n  // Put the message payload under FCM_MSG name so we can identify the notification as being an FCM\n  // notification vs a notification from somewhere else (i.e. normal web push or developer generated\n  // notification).\n  wrappedInternalPayload.data = (_a = {}, _a[FCM_MSG] = internalPayload, _a);\n  return wrappedInternalPayload;\n}\nfunction getMessagePayloadInternal(_a) {\n  var data = _a.data;\n  if (!data) {\n    return null;\n  }\n  try {\n    return data.json();\n  } catch (err) {\n    // Not JSON so not an FCM message.\n    return null;\n  }\n}\n/**\r\n * @param url The URL to look for when focusing a client.\r\n * @return Returns an existing window client or a newly opened WindowClient.\r\n */\nfunction getWindowClient(url) {\n  return __awaiter(this, void 0, void 0, function () {\n    var clientList, clientList_1, clientList_1_1, client, clientUrl;\n    var e_1, _a;\n    return __generator(this, function (_b) {\n      switch (_b.label) {\n        case 0:\n          return [4 /*yield*/, getClientList()];\n        case 1:\n          clientList = _b.sent();\n          try {\n            for (clientList_1 = __values(clientList), clientList_1_1 = clientList_1.next(); !clientList_1_1.done; clientList_1_1 = clientList_1.next()) {\n              client = clientList_1_1.value;\n              clientUrl = new URL(client.url, self.location.href);\n              if (url.host === clientUrl.host) {\n                return [2 /*return*/, client];\n              }\n            }\n          } catch (e_1_1) {\n            e_1 = {\n              error: e_1_1\n            };\n          } finally {\n            try {\n              if (clientList_1_1 && !clientList_1_1.done && (_a = clientList_1.return)) _a.call(clientList_1);\n            } finally {\n              if (e_1) throw e_1.error;\n            }\n          }\n          return [2 /*return*/, null];\n      }\n    });\n  });\n}\n/**\r\n * @returns If there is currently a visible WindowClient, this method will resolve to true,\r\n * otherwise false.\r\n */\nfunction hasVisibleClients(clientList) {\n  return clientList.some(function (client) {\n    return client.visibilityState === 'visible' &&\n    // Ignore chrome-extension clients as that matches the background pages of extensions, which\n    // are always considered visible for some reason.\n    !client.url.startsWith('chrome-extension://');\n  });\n}\nfunction sendMessagePayloadInternalToWindows(clientList, internalPayload) {\n  var e_2, _a;\n  internalPayload.isFirebaseMessaging = true;\n  internalPayload.messageType = MessageType.PUSH_RECEIVED;\n  try {\n    for (var clientList_2 = __values(clientList), clientList_2_1 = clientList_2.next(); !clientList_2_1.done; clientList_2_1 = clientList_2.next()) {\n      var client = clientList_2_1.value;\n      client.postMessage(internalPayload);\n    }\n  } catch (e_2_1) {\n    e_2 = {\n      error: e_2_1\n    };\n  } finally {\n    try {\n      if (clientList_2_1 && !clientList_2_1.done && (_a = clientList_2.return)) _a.call(clientList_2);\n    } finally {\n      if (e_2) throw e_2.error;\n    }\n  }\n}\nfunction getClientList() {\n  return self.clients.matchAll({\n    type: 'window',\n    includeUncontrolled: true\n    // TS doesn't know that \"type: 'window'\" means it'll return WindowClient[]\n  });\n}\nfunction showNotification(notificationPayloadInternal) {\n  var _a;\n  // Note: Firefox does not support the maxActions property.\n  // https://developer.mozilla.org/en-US/docs/Web/API/notification/maxActions\n  var actions = notificationPayloadInternal.actions;\n  var maxActions = Notification.maxActions;\n  if (actions && maxActions && actions.length > maxActions) {\n    console.warn(\"This browser only supports \" + maxActions + \" actions. The remaining actions will not be displayed.\");\n  }\n  return self.registration.showNotification( /* title= */(_a = notificationPayloadInternal.title) !== null && _a !== void 0 ? _a : '', notificationPayloadInternal);\n}\nfunction getLink(payload) {\n  var _a, _b, _c;\n  // eslint-disable-next-line camelcase\n  var link = (_b = (_a = payload.fcmOptions) === null || _a === void 0 ? void 0 : _a.link) !== null && _b !== void 0 ? _b : (_c = payload.notification) === null || _c === void 0 ? void 0 : _c.click_action;\n  if (link) {\n    return link;\n  }\n  if (isConsoleMessage(payload.data)) {\n    // Notification created in the Firebase Console. Redirect to origin.\n    return self.location.origin;\n  } else {\n    return null;\n  }\n}\n\n/**\r\n * @license\r\n * Copyright 2017 Google LLC\r\n *\r\n * Licensed under the Apache License, Version 2.0 (the \"License\");\r\n * you may not use this file except in compliance with the License.\r\n * You may obtain a copy of the License at\r\n *\r\n *   http://www.apache.org/licenses/LICENSE-2.0\r\n *\r\n * Unless required by applicable law or agreed to in writing, software\r\n * distributed under the License is distributed on an \"AS IS\" BASIS,\r\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\r\n * See the License for the specific language governing permissions and\r\n * limitations under the License.\r\n */\nvar WindowController = /** @class */function () {\n  function WindowController(firebaseDependencies) {\n    var _this = this;\n    this.firebaseDependencies = firebaseDependencies;\n    this.vapidKey = null;\n    this.onMessageCallback = null;\n    navigator.serviceWorker.addEventListener('message', function (e) {\n      return _this.messageEventListener(e);\n    });\n  }\n  Object.defineProperty(WindowController.prototype, \"app\", {\n    get: function () {\n      return this.firebaseDependencies.app;\n    },\n    enumerable: false,\n    configurable: true\n  });\n  WindowController.prototype.messageEventListener = function (event) {\n    return __awaiter(this, void 0, void 0, function () {\n      var internalPayload, dataPayload;\n      return __generator(this, function (_a) {\n        switch (_a.label) {\n          case 0:\n            internalPayload = event.data;\n            if (!internalPayload.isFirebaseMessaging) {\n              return [2 /*return*/];\n            }\n            // onMessageCallback is either a function or observer/subscriber.\n            // TODO: in the modularization release, have onMessage handle type MessagePayload as supposed to\n            // the legacy payload where some fields are in snake cases.\n            if (this.onMessageCallback && internalPayload.messageType === MessageType.PUSH_RECEIVED) {\n              if (typeof this.onMessageCallback === 'function') {\n                this.onMessageCallback(stripInternalFields(Object.assign({}, internalPayload)));\n              } else {\n                this.onMessageCallback.next(Object.assign({}, internalPayload));\n              }\n            }\n            dataPayload = internalPayload.data;\n            if (!(isConsoleMessage(dataPayload) && dataPayload[CONSOLE_CAMPAIGN_ANALYTICS_ENABLED] === '1')) return [3 /*break*/, 2];\n            return [4 /*yield*/, this.logEvent(internalPayload.messageType, dataPayload)];\n          case 1:\n            _a.sent();\n            _a.label = 2;\n          case 2:\n            return [2 /*return*/];\n        }\n      });\n    });\n  };\n  WindowController.prototype.getVapidKey = function () {\n    return this.vapidKey;\n  };\n  WindowController.prototype.getSwReg = function () {\n    return this.swRegistration;\n  };\n  WindowController.prototype.getToken = function (options) {\n    return __awaiter(this, void 0, void 0, function () {\n      return __generator(this, function (_a) {\n        switch (_a.label) {\n          case 0:\n            if (!(Notification.permission === 'default')) return [3 /*break*/, 2];\n            return [4 /*yield*/, Notification.requestPermission()];\n          case 1:\n            _a.sent();\n            _a.label = 2;\n          case 2:\n            if (Notification.permission !== 'granted') {\n              throw ERROR_FACTORY.create(\"permission-blocked\" /* PERMISSION_BLOCKED */);\n            }\n            return [4 /*yield*/, this.updateVapidKey(options === null || options === void 0 ? void 0 : options.vapidKey)];\n          case 3:\n            _a.sent();\n            return [4 /*yield*/, this.updateSwReg(options === null || options === void 0 ? void 0 : options.serviceWorkerRegistration)];\n          case 4:\n            _a.sent();\n            return [2 /*return*/, getToken(this.firebaseDependencies, this.swRegistration, this.vapidKey)];\n        }\n      });\n    });\n  };\n  WindowController.prototype.updateVapidKey = function (vapidKey) {\n    return __awaiter(this, void 0, void 0, function () {\n      return __generator(this, function (_a) {\n        if (!!vapidKey) {\n          this.vapidKey = vapidKey;\n        } else if (!this.vapidKey) {\n          this.vapidKey = DEFAULT_VAPID_KEY;\n        }\n        return [2 /*return*/];\n      });\n    });\n  };\n  WindowController.prototype.updateSwReg = function (swRegistration) {\n    return __awaiter(this, void 0, void 0, function () {\n      return __generator(this, function (_a) {\n        switch (_a.label) {\n          case 0:\n            if (!(!swRegistration && !this.swRegistration)) return [3 /*break*/, 2];\n            return [4 /*yield*/, this.registerDefaultSw()];\n          case 1:\n            _a.sent();\n            _a.label = 2;\n          case 2:\n            if (!swRegistration && !!this.swRegistration) {\n              return [2 /*return*/];\n            }\n            if (!(swRegistration instanceof ServiceWorkerRegistration)) {\n              throw ERROR_FACTORY.create(\"invalid-sw-registration\" /* INVALID_SW_REGISTRATION */);\n            }\n            this.swRegistration = swRegistration;\n            return [2 /*return*/];\n        }\n      });\n    });\n  };\n  WindowController.prototype.registerDefaultSw = function () {\n    return __awaiter(this, void 0, void 0, function () {\n      var _a, e_1;\n      return __generator(this, function (_b) {\n        switch (_b.label) {\n          case 0:\n            _b.trys.push([0, 2,, 3]);\n            _a = this;\n            return [4 /*yield*/, navigator.serviceWorker.register(DEFAULT_SW_PATH, {\n              scope: DEFAULT_SW_SCOPE\n            })];\n          case 1:\n            _a.swRegistration = _b.sent();\n            // The timing when browser updates sw when sw has an update is unreliable by my experiment. It\n            // leads to version conflict when the SDK upgrades to a newer version in the main page, but sw\n            // is stuck with the old version. For example,\n            // https://github.com/firebase/firebase-js-sdk/issues/2590 The following line reliably updates\n            // sw if there was an update.\n            this.swRegistration.update().catch(function () {\n              /* it is non blocking and we don't care if it failed */\n            });\n            return [3 /*break*/, 3];\n          case 2:\n            e_1 = _b.sent();\n            throw ERROR_FACTORY.create(\"failed-service-worker-registration\" /* FAILED_DEFAULT_REGISTRATION */, {\n              browserErrorMessage: e_1.message\n            });\n          case 3:\n            return [2 /*return*/];\n        }\n      });\n    });\n  };\n  WindowController.prototype.deleteToken = function () {\n    return __awaiter(this, void 0, void 0, function () {\n      return __generator(this, function (_a) {\n        switch (_a.label) {\n          case 0:\n            if (!!this.swRegistration) return [3 /*break*/, 2];\n            return [4 /*yield*/, this.registerDefaultSw()];\n          case 1:\n            _a.sent();\n            _a.label = 2;\n          case 2:\n            return [2 /*return*/, deleteToken(this.firebaseDependencies, this.swRegistration)];\n        }\n      });\n    });\n  };\n  /**\r\n   * Request permission if it is not currently granted.\r\n   *\r\n   * @return Resolves if the permission was granted, rejects otherwise.\r\n   *\r\n   * @deprecated Use Notification.requestPermission() instead.\r\n   * https://developer.mozilla.org/en-US/docs/Web/API/Notification/requestPermission\r\n   */\n  WindowController.prototype.requestPermission = function () {\n    return __awaiter(this, void 0, void 0, function () {\n      var permissionResult;\n      return __generator(this, function (_a) {\n        switch (_a.label) {\n          case 0:\n            if (Notification.permission === 'granted') {\n              return [2 /*return*/];\n            }\n            return [4 /*yield*/, Notification.requestPermission()];\n          case 1:\n            permissionResult = _a.sent();\n            if (permissionResult === 'granted') {\n              return [2 /*return*/];\n            } else if (permissionResult === 'denied') {\n              throw ERROR_FACTORY.create(\"permission-blocked\" /* PERMISSION_BLOCKED */);\n            } else {\n              throw ERROR_FACTORY.create(\"permission-default\" /* PERMISSION_DEFAULT */);\n            }\n        }\n      });\n    });\n  };\n  /**\r\n   * @deprecated. Use getToken(options?: {vapidKey?: string; serviceWorkerRegistration?:\r\n   * ServiceWorkerRegistration;}): Promise<string> instead.\r\n   */\n  WindowController.prototype.usePublicVapidKey = function (vapidKey) {\n    if (this.vapidKey !== null) {\n      throw ERROR_FACTORY.create(\"use-vapid-key-after-get-token\" /* USE_VAPID_KEY_AFTER_GET_TOKEN */);\n    }\n    if (typeof vapidKey !== 'string' || vapidKey.length === 0) {\n      throw ERROR_FACTORY.create(\"invalid-vapid-key\" /* INVALID_VAPID_KEY */);\n    }\n    this.vapidKey = vapidKey;\n  };\n  /**\r\n   * @deprecated. Use getToken(options?: {vapidKey?: string; serviceWorkerRegistration?:\r\n   * ServiceWorkerRegistration;}): Promise<string> instead.\r\n   */\n  WindowController.prototype.useServiceWorker = function (swRegistration) {\n    if (!(swRegistration instanceof ServiceWorkerRegistration)) {\n      throw ERROR_FACTORY.create(\"invalid-sw-registration\" /* INVALID_SW_REGISTRATION */);\n    }\n    if (this.swRegistration) {\n      throw ERROR_FACTORY.create(\"use-sw-after-get-token\" /* USE_SW_AFTER_GET_TOKEN */);\n    }\n    this.swRegistration = swRegistration;\n  };\n  /**\r\n   * @param nextOrObserver An observer object or a function triggered on message.\r\n   *\r\n   * @return The unsubscribe function for the observer.\r\n   */\n  WindowController.prototype.onMessage = function (nextOrObserver) {\n    var _this = this;\n    this.onMessageCallback = nextOrObserver;\n    return function () {\n      _this.onMessageCallback = null;\n    };\n  };\n  WindowController.prototype.setBackgroundMessageHandler = function () {\n    throw ERROR_FACTORY.create(\"only-available-in-sw\" /* AVAILABLE_IN_SW */);\n  };\n  WindowController.prototype.onBackgroundMessage = function () {\n    throw ERROR_FACTORY.create(\"only-available-in-sw\" /* AVAILABLE_IN_SW */);\n  };\n  /**\r\n   * @deprecated No-op. It was initially designed with token rotation requests from server in mind.\r\n   * However, the plan to implement such feature was abandoned.\r\n   */\n  WindowController.prototype.onTokenRefresh = function () {\n    return function () {};\n  };\n  WindowController.prototype.logEvent = function (messageType, data) {\n    return __awaiter(this, void 0, void 0, function () {\n      var eventType, analytics;\n      return __generator(this, function (_a) {\n        switch (_a.label) {\n          case 0:\n            eventType = getEventType(messageType);\n            return [4 /*yield*/, this.firebaseDependencies.analyticsProvider.get()];\n          case 1:\n            analytics = _a.sent();\n            analytics.logEvent(eventType, {\n              /* eslint-disable camelcase */\n              message_id: data[CONSOLE_CAMPAIGN_ID],\n              message_name: data[CONSOLE_CAMPAIGN_NAME],\n              message_time: data[CONSOLE_CAMPAIGN_TIME],\n              message_device_time: Math.floor(Date.now() / 1000)\n              /* eslint-enable camelcase */\n            });\n            return [2 /*return*/];\n        }\n      });\n    });\n  };\n  return WindowController;\n}();\nfunction getEventType(messageType) {\n  switch (messageType) {\n    case MessageType.NOTIFICATION_CLICKED:\n      return 'notification_open';\n    case MessageType.PUSH_RECEIVED:\n      return 'notification_foreground';\n    default:\n      throw new Error();\n  }\n}\nfunction stripInternalFields(internalPayload) {\n  delete internalPayload.messageType;\n  delete internalPayload.isFirebaseMessaging;\n  return internalPayload;\n}\n\n/**\r\n * @license\r\n * Copyright 2019 Google LLC\r\n *\r\n * Licensed under the Apache License, Version 2.0 (the \"License\");\r\n * you may not use this file except in compliance with the License.\r\n * You may obtain a copy of the License at\r\n *\r\n *   http://www.apache.org/licenses/LICENSE-2.0\r\n *\r\n * Unless required by applicable law or agreed to in writing, software\r\n * distributed under the License is distributed on an \"AS IS\" BASIS,\r\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\r\n * See the License for the specific language governing permissions and\r\n * limitations under the License.\r\n */\nfunction extractAppConfig(app) {\n  var e_1, _a;\n  if (!app || !app.options) {\n    throw getMissingValueError('App Configuration Object');\n  }\n  if (!app.name) {\n    throw getMissingValueError('App Name');\n  }\n  // Required app config keys\n  var configKeys = ['projectId', 'apiKey', 'appId', 'messagingSenderId'];\n  var options = app.options;\n  try {\n    for (var configKeys_1 = __values(configKeys), configKeys_1_1 = configKeys_1.next(); !configKeys_1_1.done; configKeys_1_1 = configKeys_1.next()) {\n      var keyName = configKeys_1_1.value;\n      if (!options[keyName]) {\n        throw getMissingValueError(keyName);\n      }\n    }\n  } catch (e_1_1) {\n    e_1 = {\n      error: e_1_1\n    };\n  } finally {\n    try {\n      if (configKeys_1_1 && !configKeys_1_1.done && (_a = configKeys_1.return)) _a.call(configKeys_1);\n    } finally {\n      if (e_1) throw e_1.error;\n    }\n  }\n  return {\n    appName: app.name,\n    projectId: options.projectId,\n    apiKey: options.apiKey,\n    appId: options.appId,\n    senderId: options.messagingSenderId\n  };\n}\nfunction getMissingValueError(valueName) {\n  return ERROR_FACTORY.create(\"missing-app-config-values\" /* MISSING_APP_CONFIG_VALUES */, {\n    valueName: valueName\n  });\n}\n\n/**\r\n * @license\r\n * Copyright 2017 Google LLC\r\n *\r\n * Licensed under the Apache License, Version 2.0 (the \"License\");\r\n * you may not use this file except in compliance with the License.\r\n * You may obtain a copy of the License at\r\n *\r\n *   http://www.apache.org/licenses/LICENSE-2.0\r\n *\r\n * Unless required by applicable law or agreed to in writing, software\r\n * distributed under the License is distributed on an \"AS IS\" BASIS,\r\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\r\n * See the License for the specific language governing permissions and\r\n * limitations under the License.\r\n */\nvar MESSAGING_NAME = 'messaging';\nfunction factoryMethod(container) {\n  // Dependencies.\n  var app = container.getProvider('app').getImmediate();\n  var appConfig = extractAppConfig(app);\n  var installations = container.getProvider('installations').getImmediate();\n  var analyticsProvider = container.getProvider('analytics-internal');\n  var firebaseDependencies = {\n    app: app,\n    appConfig: appConfig,\n    installations: installations,\n    analyticsProvider: analyticsProvider\n  };\n  if (!isSupported()) {\n    throw ERROR_FACTORY.create(\"unsupported-browser\" /* UNSUPPORTED_BROWSER */);\n  }\n  if (self && 'ServiceWorkerGlobalScope' in self) {\n    // Running in ServiceWorker context\n    return new SwController(firebaseDependencies);\n  } else {\n    // Assume we are in the window context.\n    return new WindowController(firebaseDependencies);\n  }\n}\nvar NAMESPACE_EXPORTS = {\n  isSupported: isSupported\n};\nfirebase.INTERNAL.registerComponent(new Component(MESSAGING_NAME, factoryMethod, \"PUBLIC\" /* PUBLIC */).setServiceProps(NAMESPACE_EXPORTS));\nfunction isSupported() {\n  if (self && 'ServiceWorkerGlobalScope' in self) {\n    // Running in ServiceWorker context\n    return isSWControllerSupported();\n  } else {\n    // Assume we are in the window context.\n    return isWindowControllerSupported();\n  }\n}\n/**\r\n * Checks to see if the required APIs exist.\r\n */\nfunction isWindowControllerSupported() {\n  return 'indexedDB' in window && indexedDB !== null && navigator.cookieEnabled && 'serviceWorker' in navigator && 'PushManager' in window && 'Notification' in window && 'fetch' in window && ServiceWorkerRegistration.prototype.hasOwnProperty('showNotification') && PushSubscription.prototype.hasOwnProperty('getKey');\n}\n/**\r\n * Checks to see if the required APIs exist within SW Context.\r\n */\nfunction isSWControllerSupported() {\n  return 'indexedDB' in self && indexedDB !== null && 'PushManager' in self && 'Notification' in self && ServiceWorkerRegistration.prototype.hasOwnProperty('showNotification') && PushSubscription.prototype.hasOwnProperty('getKey');\n}","map":{"version":3,"names":["Component","ErrorFactory","__spreadArray","__read","__awaiter","__generator","__assign","__values","deleteDb","openDb","firebase","_a","ERROR_MAP","ERROR_FACTORY","DEFAULT_SW_PATH","DEFAULT_SW_SCOPE","DEFAULT_VAPID_KEY","ENDPOINT","FCM_MSG","TAG","CONSOLE_CAMPAIGN_ANALYTICS_ENABLED","CONSOLE_CAMPAIGN_ID","CONSOLE_CAMPAIGN_TIME","CONSOLE_CAMPAIGN_NAME","BACKGROUND_HANDLE_EXECUTION_TIME_LIMIT_MS","FOREGROUND_HANDLE_PREPARATION_TIME_MS","MessageType","arrayToBase64","array","uint8Array","Uint8Array","base64String","btoa","String","fromCharCode","apply","replace","base64ToArray","padding","repeat","length","base64","rawData","atob","outputArray","i","charCodeAt","OLD_DB_NAME","OLD_DB_VERSION","OLD_OBJECT_STORE_NAME","migrateOldDatabase","senderId","databases","dbNames","tokenDetails","db","_this","label","indexedDB","sent","map","name","includes","objectStore","value","oldDetails","_b","oldVersion","objectStoreNames","contains","transaction","index","get","clear","auth","p256dh","endpoint","token","fcmToken","createTime","Date","now","subscriptionOptions","swScope","vapidKey","close","checkTokenDetails","DATABASE_NAME","DATABASE_VERSION","OBJECT_STORE_NAME","dbPromise","getDbPromise","upgradeDb","createObjectStore","dbGet","firebaseDependencies","key","oldTokenDetails","getKey","appConfig","dbSet","tx","put","complete","dbRemove","delete","appId","requestGetToken","headers","body","subscribeOptions","responseData","response","err_1","message","getHeaders","getBody","method","JSON","stringify","trys","push","fetch","getEndpoint","json","create","errorInfo","error","requestUpdateToken","updateOptions","err_2","requestDeleteToken","unsubscribeOptions","err_3","projectId","installations","authToken","getToken","Headers","Accept","apiKey","web","applicationPubKey","TOKEN_EXPIRATION_MS","swRegistration","pushSubscription","e_1","Notification","permission","getPushSubscription","scope","getNewToken","isTokenValid","console","warn","updateToken","deleteToken","pushManager","getSubscription","unsubscribe","updatedToken","updatedTokenDetails","e_2","subscription","subscribe","userVisibleOnly","applicationServerKey","dbOptions","currentOptions","isVapidKeyEqual","isEndpointEqual","isAuthEqual","isP256dhEqual","externalizePayload","internalPayload","payload","from","collapseKey","collapse_key","messageId","fcm_message_id","propagateNotificationPayload","propagateDataPayload","propagateFcmOptions","messagePayloadInternal","notification","title","image","data","fcmOptions","link","analyticsLabel","analytics_label","isConsoleMessage","sleep","ms","Promise","resolve","setTimeout","SwController","isOnBackgroundMessageUsed","bgMessageHandler","self","addEventListener","e","waitUntil","onPush","onSubChange","onNotificationClick","Object","defineProperty","prototype","app","enumerable","configurable","setBackgroundMessageHandler","callback","onBackgroundMessage","nextOrObserver","_c","registration","requestPermission","usePublicVapidKey","useServiceWorker","onMessage","onTokenRefresh","event","clientList","isNotificationShown","getMessagePayloadInternal","debug","getClientList","hasVisibleClients","sendMessagePayloadInternalToWindows","showNotification","wrapInternalPayload","next","newSubscription","url","originUrl","client","action","stopImmediatePropagation","getLink","URL","location","href","origin","host","getWindowClient","clients","openWindow","focus","messageType","NOTIFICATION_CLICKED","isFirebaseMessaging","postMessage","wrappedInternalPayload","err","clientList_1","clientList_1_1","clientUrl","done","e_1_1","return","call","some","visibilityState","startsWith","PUSH_RECEIVED","clientList_2","clientList_2_1","e_2_1","matchAll","type","includeUncontrolled","notificationPayloadInternal","actions","maxActions","click_action","WindowController","onMessageCallback","navigator","serviceWorker","messageEventListener","dataPayload","stripInternalFields","assign","logEvent","getVapidKey","getSwReg","options","updateVapidKey","updateSwReg","serviceWorkerRegistration","registerDefaultSw","ServiceWorkerRegistration","register","update","catch","browserErrorMessage","permissionResult","eventType","analytics","getEventType","analyticsProvider","message_id","message_name","message_time","message_device_time","Math","floor","Error","extractAppConfig","getMissingValueError","configKeys","configKeys_1","configKeys_1_1","keyName","appName","messagingSenderId","valueName","MESSAGING_NAME","factoryMethod","container","getProvider","getImmediate","isSupported","NAMESPACE_EXPORTS","INTERNAL","registerComponent","setServiceProps","isSWControllerSupported","isWindowControllerSupported","window","cookieEnabled","hasOwnProperty","PushSubscription"],"sources":["C:/Progect for learning/angular-blog/node_modules/@firebase/messaging/dist/index.esm.js"],"sourcesContent":["import '@firebase/installations';\nimport { Component } from '@firebase/component';\nimport { ErrorFactory } from '@firebase/util';\nimport { __spreadArray, __read, __awaiter, __generator, __assign, __values } from 'tslib';\nimport { deleteDb, openDb } from 'idb';\nimport firebase from '@firebase/app';\n\n/**\r\n * @license\r\n * Copyright 2017 Google LLC\r\n *\r\n * Licensed under the Apache License, Version 2.0 (the \"License\");\r\n * you may not use this file except in compliance with the License.\r\n * You may obtain a copy of the License at\r\n *\r\n *   http://www.apache.org/licenses/LICENSE-2.0\r\n *\r\n * Unless required by applicable law or agreed to in writing, software\r\n * distributed under the License is distributed on an \"AS IS\" BASIS,\r\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\r\n * See the License for the specific language governing permissions and\r\n * limitations under the License.\r\n */\r\nvar _a;\r\nvar ERROR_MAP = (_a = {},\r\n    _a[\"missing-app-config-values\" /* MISSING_APP_CONFIG_VALUES */] = 'Missing App configuration value: \"{$valueName}\"',\r\n    _a[\"only-available-in-window\" /* AVAILABLE_IN_WINDOW */] = 'This method is available in a Window context.',\r\n    _a[\"only-available-in-sw\" /* AVAILABLE_IN_SW */] = 'This method is available in a service worker context.',\r\n    _a[\"permission-default\" /* PERMISSION_DEFAULT */] = 'The notification permission was not granted and dismissed instead.',\r\n    _a[\"permission-blocked\" /* PERMISSION_BLOCKED */] = 'The notification permission was not granted and blocked instead.',\r\n    _a[\"unsupported-browser\" /* UNSUPPORTED_BROWSER */] = \"This browser doesn't support the API's required to use the firebase SDK.\",\r\n    _a[\"failed-service-worker-registration\" /* FAILED_DEFAULT_REGISTRATION */] = 'We are unable to register the default service worker. {$browserErrorMessage}',\r\n    _a[\"token-subscribe-failed\" /* TOKEN_SUBSCRIBE_FAILED */] = 'A problem occurred while subscribing the user to FCM: {$errorInfo}',\r\n    _a[\"token-subscribe-no-token\" /* TOKEN_SUBSCRIBE_NO_TOKEN */] = 'FCM returned no token when subscribing the user to push.',\r\n    _a[\"token-unsubscribe-failed\" /* TOKEN_UNSUBSCRIBE_FAILED */] = 'A problem occurred while unsubscribing the ' +\r\n        'user from FCM: {$errorInfo}',\r\n    _a[\"token-update-failed\" /* TOKEN_UPDATE_FAILED */] = 'A problem occurred while updating the user from FCM: {$errorInfo}',\r\n    _a[\"token-update-no-token\" /* TOKEN_UPDATE_NO_TOKEN */] = 'FCM returned no token when updating the user to push.',\r\n    _a[\"use-sw-after-get-token\" /* USE_SW_AFTER_GET_TOKEN */] = 'The useServiceWorker() method may only be called once and must be ' +\r\n        'called before calling getToken() to ensure your service worker is used.',\r\n    _a[\"invalid-sw-registration\" /* INVALID_SW_REGISTRATION */] = 'The input to useServiceWorker() must be a ServiceWorkerRegistration.',\r\n    _a[\"invalid-bg-handler\" /* INVALID_BG_HANDLER */] = 'The input to setBackgroundMessageHandler() must be a function.',\r\n    _a[\"invalid-vapid-key\" /* INVALID_VAPID_KEY */] = 'The public VAPID key must be a string.',\r\n    _a[\"use-vapid-key-after-get-token\" /* USE_VAPID_KEY_AFTER_GET_TOKEN */] = 'The usePublicVapidKey() method may only be called once and must be ' +\r\n        'called before calling getToken() to ensure your VAPID key is used.',\r\n    _a);\r\nvar ERROR_FACTORY = new ErrorFactory('messaging', 'Messaging', ERROR_MAP);\n\n/**\r\n * @license\r\n * Copyright 2019 Google LLC\r\n *\r\n * Licensed under the Apache License, Version 2.0 (the \"License\");\r\n * you may not use this file except in compliance with the License.\r\n * You may obtain a copy of the License at\r\n *\r\n *   http://www.apache.org/licenses/LICENSE-2.0\r\n *\r\n * Unless required by applicable law or agreed to in writing, software\r\n * distributed under the License is distributed on an \"AS IS\" BASIS,\r\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\r\n * See the License for the specific language governing permissions and\r\n * limitations under the License.\r\n */\r\nvar DEFAULT_SW_PATH = '/firebase-messaging-sw.js';\r\nvar DEFAULT_SW_SCOPE = '/firebase-cloud-messaging-push-scope';\r\nvar DEFAULT_VAPID_KEY = 'BDOU99-h67HcA6JeFXHbSNMu7e2yNNu3RzoMj8TM4W88jITfq7ZmPvIM1Iv-4_l2LxQcYwhqby2xGpWwzjfAnG4';\r\nvar ENDPOINT = 'https://fcmregistrations.googleapis.com/v1';\r\n// Key of FCM Payload in Notification's data field.\r\nvar FCM_MSG = 'FCM_MSG';\r\nvar TAG = 'FirebaseMessaging: ';\r\n// Set to '1' if Analytics is enabled for the campaign\r\nvar CONSOLE_CAMPAIGN_ANALYTICS_ENABLED = 'google.c.a.e';\r\nvar CONSOLE_CAMPAIGN_ID = 'google.c.a.c_id';\r\nvar CONSOLE_CAMPAIGN_TIME = 'google.c.a.ts';\r\nvar CONSOLE_CAMPAIGN_NAME = 'google.c.a.c_l';\r\n// Due to the fact that onBackgroundMessage can't be awaited (to support rxjs), a silent push\r\n// warning might be shown by the browser if the callback fails to completes by the end of onPush.\r\n// Experiments were ran to determine the majority onBackground message clock time. This brief\r\n// blocking time would allow majority of the onBackgroundMessage callback to finish.\r\nvar BACKGROUND_HANDLE_EXECUTION_TIME_LIMIT_MS = 1000;\r\n// Preparation time for client to initialize and set up the message handler.\r\nvar FOREGROUND_HANDLE_PREPARATION_TIME_MS = 3000;\n\n/**\r\n * @license\r\n * Copyright 2018 Google LLC\r\n *\r\n * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except\r\n * in compliance with the License. You may obtain a copy of the License at\r\n *\r\n * http://www.apache.org/licenses/LICENSE-2.0\r\n *\r\n * Unless required by applicable law or agreed to in writing, software distributed under the License\r\n * is distributed on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express\r\n * or implied. See the License for the specific language governing permissions and limitations under\r\n * the License.\r\n */\r\nvar MessageType;\r\n(function (MessageType) {\r\n    MessageType[\"PUSH_RECEIVED\"] = \"push-received\";\r\n    MessageType[\"NOTIFICATION_CLICKED\"] = \"notification-clicked\";\r\n})(MessageType || (MessageType = {}));\n\n/**\r\n * @license\r\n * Copyright 2017 Google LLC\r\n *\r\n * Licensed under the Apache License, Version 2.0 (the \"License\");\r\n * you may not use this file except in compliance with the License.\r\n * You may obtain a copy of the License at\r\n *\r\n *   http://www.apache.org/licenses/LICENSE-2.0\r\n *\r\n * Unless required by applicable law or agreed to in writing, software\r\n * distributed under the License is distributed on an \"AS IS\" BASIS,\r\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\r\n * See the License for the specific language governing permissions and\r\n * limitations under the License.\r\n */\r\nfunction arrayToBase64(array) {\r\n    var uint8Array = new Uint8Array(array);\r\n    var base64String = btoa(String.fromCharCode.apply(String, __spreadArray([], __read(uint8Array))));\r\n    return base64String.replace(/=/g, '').replace(/\\+/g, '-').replace(/\\//g, '_');\r\n}\r\nfunction base64ToArray(base64String) {\r\n    var padding = '='.repeat((4 - (base64String.length % 4)) % 4);\r\n    var base64 = (base64String + padding)\r\n        .replace(/\\-/g, '+')\r\n        .replace(/_/g, '/');\r\n    var rawData = atob(base64);\r\n    var outputArray = new Uint8Array(rawData.length);\r\n    for (var i = 0; i < rawData.length; ++i) {\r\n        outputArray[i] = rawData.charCodeAt(i);\r\n    }\r\n    return outputArray;\r\n}\n\n/**\r\n * @license\r\n * Copyright 2019 Google LLC\r\n *\r\n * Licensed under the Apache License, Version 2.0 (the \"License\");\r\n * you may not use this file except in compliance with the License.\r\n * You may obtain a copy of the License at\r\n *\r\n *   http://www.apache.org/licenses/LICENSE-2.0\r\n *\r\n * Unless required by applicable law or agreed to in writing, software\r\n * distributed under the License is distributed on an \"AS IS\" BASIS,\r\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\r\n * See the License for the specific language governing permissions and\r\n * limitations under the License.\r\n */\r\nvar OLD_DB_NAME = 'fcm_token_details_db';\r\n/**\r\n * The last DB version of 'fcm_token_details_db' was 4. This is one higher, so that the upgrade\r\n * callback is called for all versions of the old DB.\r\n */\r\nvar OLD_DB_VERSION = 5;\r\nvar OLD_OBJECT_STORE_NAME = 'fcm_token_object_Store';\r\nfunction migrateOldDatabase(senderId) {\r\n    return __awaiter(this, void 0, void 0, function () {\r\n        var databases, dbNames, tokenDetails, db;\r\n        var _this = this;\r\n        return __generator(this, function (_a) {\r\n            switch (_a.label) {\r\n                case 0:\r\n                    if (!('databases' in indexedDB)) return [3 /*break*/, 2];\r\n                    return [4 /*yield*/, indexedDB.databases()];\r\n                case 1:\r\n                    databases = _a.sent();\r\n                    dbNames = databases.map(function (db) { return db.name; });\r\n                    if (!dbNames.includes(OLD_DB_NAME)) {\r\n                        // old DB didn't exist, no need to open.\r\n                        return [2 /*return*/, null];\r\n                    }\r\n                    _a.label = 2;\r\n                case 2:\r\n                    tokenDetails = null;\r\n                    return [4 /*yield*/, openDb(OLD_DB_NAME, OLD_DB_VERSION, function (db) { return __awaiter(_this, void 0, void 0, function () {\r\n                            var objectStore, value, oldDetails, oldDetails, oldDetails;\r\n                            var _a;\r\n                            return __generator(this, function (_b) {\r\n                                switch (_b.label) {\r\n                                    case 0:\r\n                                        if (db.oldVersion < 2) {\r\n                                            // Database too old, skip migration.\r\n                                            return [2 /*return*/];\r\n                                        }\r\n                                        if (!db.objectStoreNames.contains(OLD_OBJECT_STORE_NAME)) {\r\n                                            // Database did not exist. Nothing to do.\r\n                                            return [2 /*return*/];\r\n                                        }\r\n                                        objectStore = db.transaction.objectStore(OLD_OBJECT_STORE_NAME);\r\n                                        return [4 /*yield*/, objectStore.index('fcmSenderId').get(senderId)];\r\n                                    case 1:\r\n                                        value = _b.sent();\r\n                                        return [4 /*yield*/, objectStore.clear()];\r\n                                    case 2:\r\n                                        _b.sent();\r\n                                        if (!value) {\r\n                                            // No entry in the database, nothing to migrate.\r\n                                            return [2 /*return*/];\r\n                                        }\r\n                                        if (db.oldVersion === 2) {\r\n                                            oldDetails = value;\r\n                                            if (!oldDetails.auth || !oldDetails.p256dh || !oldDetails.endpoint) {\r\n                                                return [2 /*return*/];\r\n                                            }\r\n                                            tokenDetails = {\r\n                                                token: oldDetails.fcmToken,\r\n                                                createTime: (_a = oldDetails.createTime) !== null && _a !== void 0 ? _a : Date.now(),\r\n                                                subscriptionOptions: {\r\n                                                    auth: oldDetails.auth,\r\n                                                    p256dh: oldDetails.p256dh,\r\n                                                    endpoint: oldDetails.endpoint,\r\n                                                    swScope: oldDetails.swScope,\r\n                                                    vapidKey: typeof oldDetails.vapidKey === 'string'\r\n                                                        ? oldDetails.vapidKey\r\n                                                        : arrayToBase64(oldDetails.vapidKey)\r\n                                                }\r\n                                            };\r\n                                        }\r\n                                        else if (db.oldVersion === 3) {\r\n                                            oldDetails = value;\r\n                                            tokenDetails = {\r\n                                                token: oldDetails.fcmToken,\r\n                                                createTime: oldDetails.createTime,\r\n                                                subscriptionOptions: {\r\n                                                    auth: arrayToBase64(oldDetails.auth),\r\n                                                    p256dh: arrayToBase64(oldDetails.p256dh),\r\n                                                    endpoint: oldDetails.endpoint,\r\n                                                    swScope: oldDetails.swScope,\r\n                                                    vapidKey: arrayToBase64(oldDetails.vapidKey)\r\n                                                }\r\n                                            };\r\n                                        }\r\n                                        else if (db.oldVersion === 4) {\r\n                                            oldDetails = value;\r\n                                            tokenDetails = {\r\n                                                token: oldDetails.fcmToken,\r\n                                                createTime: oldDetails.createTime,\r\n                                                subscriptionOptions: {\r\n                                                    auth: arrayToBase64(oldDetails.auth),\r\n                                                    p256dh: arrayToBase64(oldDetails.p256dh),\r\n                                                    endpoint: oldDetails.endpoint,\r\n                                                    swScope: oldDetails.swScope,\r\n                                                    vapidKey: arrayToBase64(oldDetails.vapidKey)\r\n                                                }\r\n                                            };\r\n                                        }\r\n                                        return [2 /*return*/];\r\n                                }\r\n                            });\r\n                        }); })];\r\n                case 3:\r\n                    db = _a.sent();\r\n                    db.close();\r\n                    // Delete all old databases.\r\n                    return [4 /*yield*/, deleteDb(OLD_DB_NAME)];\r\n                case 4:\r\n                    // Delete all old databases.\r\n                    _a.sent();\r\n                    return [4 /*yield*/, deleteDb('fcm_vapid_details_db')];\r\n                case 5:\r\n                    _a.sent();\r\n                    return [4 /*yield*/, deleteDb('undefined')];\r\n                case 6:\r\n                    _a.sent();\r\n                    return [2 /*return*/, checkTokenDetails(tokenDetails) ? tokenDetails : null];\r\n            }\r\n        });\r\n    });\r\n}\r\nfunction checkTokenDetails(tokenDetails) {\r\n    if (!tokenDetails || !tokenDetails.subscriptionOptions) {\r\n        return false;\r\n    }\r\n    var subscriptionOptions = tokenDetails.subscriptionOptions;\r\n    return (typeof tokenDetails.createTime === 'number' &&\r\n        tokenDetails.createTime > 0 &&\r\n        typeof tokenDetails.token === 'string' &&\r\n        tokenDetails.token.length > 0 &&\r\n        typeof subscriptionOptions.auth === 'string' &&\r\n        subscriptionOptions.auth.length > 0 &&\r\n        typeof subscriptionOptions.p256dh === 'string' &&\r\n        subscriptionOptions.p256dh.length > 0 &&\r\n        typeof subscriptionOptions.endpoint === 'string' &&\r\n        subscriptionOptions.endpoint.length > 0 &&\r\n        typeof subscriptionOptions.swScope === 'string' &&\r\n        subscriptionOptions.swScope.length > 0 &&\r\n        typeof subscriptionOptions.vapidKey === 'string' &&\r\n        subscriptionOptions.vapidKey.length > 0);\r\n}\n\n/**\r\n * @license\r\n * Copyright 2019 Google LLC\r\n *\r\n * Licensed under the Apache License, Version 2.0 (the \"License\");\r\n * you may not use this file except in compliance with the License.\r\n * You may obtain a copy of the License at\r\n *\r\n *   http://www.apache.org/licenses/LICENSE-2.0\r\n *\r\n * Unless required by applicable law or agreed to in writing, software\r\n * distributed under the License is distributed on an \"AS IS\" BASIS,\r\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\r\n * See the License for the specific language governing permissions and\r\n * limitations under the License.\r\n */\r\n// Exported for tests.\r\nvar DATABASE_NAME = 'firebase-messaging-database';\r\nvar DATABASE_VERSION = 1;\r\nvar OBJECT_STORE_NAME = 'firebase-messaging-store';\r\nvar dbPromise = null;\r\nfunction getDbPromise() {\r\n    if (!dbPromise) {\r\n        dbPromise = openDb(DATABASE_NAME, DATABASE_VERSION, function (upgradeDb) {\r\n            // We don't use 'break' in this switch statement, the fall-through behavior is what we want,\r\n            // because if there are multiple versions between the old version and the current version, we\r\n            // want ALL the migrations that correspond to those versions to run, not only the last one.\r\n            // eslint-disable-next-line default-case\r\n            switch (upgradeDb.oldVersion) {\r\n                case 0:\r\n                    upgradeDb.createObjectStore(OBJECT_STORE_NAME);\r\n            }\r\n        });\r\n    }\r\n    return dbPromise;\r\n}\r\n/** Gets record(s) from the objectStore that match the given key. */\r\nfunction dbGet(firebaseDependencies) {\r\n    return __awaiter(this, void 0, void 0, function () {\r\n        var key, db, tokenDetails, oldTokenDetails;\r\n        return __generator(this, function (_a) {\r\n            switch (_a.label) {\r\n                case 0:\r\n                    key = getKey(firebaseDependencies);\r\n                    return [4 /*yield*/, getDbPromise()];\r\n                case 1:\r\n                    db = _a.sent();\r\n                    return [4 /*yield*/, db\r\n                            .transaction(OBJECT_STORE_NAME)\r\n                            .objectStore(OBJECT_STORE_NAME)\r\n                            .get(key)];\r\n                case 2:\r\n                    tokenDetails = _a.sent();\r\n                    if (!tokenDetails) return [3 /*break*/, 3];\r\n                    return [2 /*return*/, tokenDetails];\r\n                case 3: return [4 /*yield*/, migrateOldDatabase(firebaseDependencies.appConfig.senderId)];\r\n                case 4:\r\n                    oldTokenDetails = _a.sent();\r\n                    if (!oldTokenDetails) return [3 /*break*/, 6];\r\n                    return [4 /*yield*/, dbSet(firebaseDependencies, oldTokenDetails)];\r\n                case 5:\r\n                    _a.sent();\r\n                    return [2 /*return*/, oldTokenDetails];\r\n                case 6: return [2 /*return*/];\r\n            }\r\n        });\r\n    });\r\n}\r\n/** Assigns or overwrites the record for the given key with the given value. */\r\nfunction dbSet(firebaseDependencies, tokenDetails) {\r\n    return __awaiter(this, void 0, void 0, function () {\r\n        var key, db, tx;\r\n        return __generator(this, function (_a) {\r\n            switch (_a.label) {\r\n                case 0:\r\n                    key = getKey(firebaseDependencies);\r\n                    return [4 /*yield*/, getDbPromise()];\r\n                case 1:\r\n                    db = _a.sent();\r\n                    tx = db.transaction(OBJECT_STORE_NAME, 'readwrite');\r\n                    return [4 /*yield*/, tx.objectStore(OBJECT_STORE_NAME).put(tokenDetails, key)];\r\n                case 2:\r\n                    _a.sent();\r\n                    return [4 /*yield*/, tx.complete];\r\n                case 3:\r\n                    _a.sent();\r\n                    return [2 /*return*/, tokenDetails];\r\n            }\r\n        });\r\n    });\r\n}\r\n/** Removes record(s) from the objectStore that match the given key. */\r\nfunction dbRemove(firebaseDependencies) {\r\n    return __awaiter(this, void 0, void 0, function () {\r\n        var key, db, tx;\r\n        return __generator(this, function (_a) {\r\n            switch (_a.label) {\r\n                case 0:\r\n                    key = getKey(firebaseDependencies);\r\n                    return [4 /*yield*/, getDbPromise()];\r\n                case 1:\r\n                    db = _a.sent();\r\n                    tx = db.transaction(OBJECT_STORE_NAME, 'readwrite');\r\n                    return [4 /*yield*/, tx.objectStore(OBJECT_STORE_NAME).delete(key)];\r\n                case 2:\r\n                    _a.sent();\r\n                    return [4 /*yield*/, tx.complete];\r\n                case 3:\r\n                    _a.sent();\r\n                    return [2 /*return*/];\r\n            }\r\n        });\r\n    });\r\n}\r\nfunction getKey(_a) {\r\n    var appConfig = _a.appConfig;\r\n    return appConfig.appId;\r\n}\n\n/**\r\n * @license\r\n * Copyright 2019 Google LLC\r\n *\r\n * Licensed under the Apache License, Version 2.0 (the \"License\");\r\n * you may not use this file except in compliance with the License.\r\n * You may obtain a copy of the License at\r\n *\r\n *   http://www.apache.org/licenses/LICENSE-2.0\r\n *\r\n * Unless required by applicable law or agreed to in writing, software\r\n * distributed under the License is distributed on an \"AS IS\" BASIS,\r\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\r\n * See the License for the specific language governing permissions and\r\n * limitations under the License.\r\n */\r\nfunction requestGetToken(firebaseDependencies, subscriptionOptions) {\r\n    return __awaiter(this, void 0, void 0, function () {\r\n        var headers, body, subscribeOptions, responseData, response, err_1, message;\r\n        return __generator(this, function (_a) {\r\n            switch (_a.label) {\r\n                case 0: return [4 /*yield*/, getHeaders(firebaseDependencies)];\r\n                case 1:\r\n                    headers = _a.sent();\r\n                    body = getBody(subscriptionOptions);\r\n                    subscribeOptions = {\r\n                        method: 'POST',\r\n                        headers: headers,\r\n                        body: JSON.stringify(body)\r\n                    };\r\n                    _a.label = 2;\r\n                case 2:\r\n                    _a.trys.push([2, 5, , 6]);\r\n                    return [4 /*yield*/, fetch(getEndpoint(firebaseDependencies.appConfig), subscribeOptions)];\r\n                case 3:\r\n                    response = _a.sent();\r\n                    return [4 /*yield*/, response.json()];\r\n                case 4:\r\n                    responseData = _a.sent();\r\n                    return [3 /*break*/, 6];\r\n                case 5:\r\n                    err_1 = _a.sent();\r\n                    throw ERROR_FACTORY.create(\"token-subscribe-failed\" /* TOKEN_SUBSCRIBE_FAILED */, {\r\n                        errorInfo: err_1\r\n                    });\r\n                case 6:\r\n                    if (responseData.error) {\r\n                        message = responseData.error.message;\r\n                        throw ERROR_FACTORY.create(\"token-subscribe-failed\" /* TOKEN_SUBSCRIBE_FAILED */, {\r\n                            errorInfo: message\r\n                        });\r\n                    }\r\n                    if (!responseData.token) {\r\n                        throw ERROR_FACTORY.create(\"token-subscribe-no-token\" /* TOKEN_SUBSCRIBE_NO_TOKEN */);\r\n                    }\r\n                    return [2 /*return*/, responseData.token];\r\n            }\r\n        });\r\n    });\r\n}\r\nfunction requestUpdateToken(firebaseDependencies, tokenDetails) {\r\n    return __awaiter(this, void 0, void 0, function () {\r\n        var headers, body, updateOptions, responseData, response, err_2, message;\r\n        return __generator(this, function (_a) {\r\n            switch (_a.label) {\r\n                case 0: return [4 /*yield*/, getHeaders(firebaseDependencies)];\r\n                case 1:\r\n                    headers = _a.sent();\r\n                    body = getBody(tokenDetails.subscriptionOptions);\r\n                    updateOptions = {\r\n                        method: 'PATCH',\r\n                        headers: headers,\r\n                        body: JSON.stringify(body)\r\n                    };\r\n                    _a.label = 2;\r\n                case 2:\r\n                    _a.trys.push([2, 5, , 6]);\r\n                    return [4 /*yield*/, fetch(getEndpoint(firebaseDependencies.appConfig) + \"/\" + tokenDetails.token, updateOptions)];\r\n                case 3:\r\n                    response = _a.sent();\r\n                    return [4 /*yield*/, response.json()];\r\n                case 4:\r\n                    responseData = _a.sent();\r\n                    return [3 /*break*/, 6];\r\n                case 5:\r\n                    err_2 = _a.sent();\r\n                    throw ERROR_FACTORY.create(\"token-update-failed\" /* TOKEN_UPDATE_FAILED */, {\r\n                        errorInfo: err_2\r\n                    });\r\n                case 6:\r\n                    if (responseData.error) {\r\n                        message = responseData.error.message;\r\n                        throw ERROR_FACTORY.create(\"token-update-failed\" /* TOKEN_UPDATE_FAILED */, {\r\n                            errorInfo: message\r\n                        });\r\n                    }\r\n                    if (!responseData.token) {\r\n                        throw ERROR_FACTORY.create(\"token-update-no-token\" /* TOKEN_UPDATE_NO_TOKEN */);\r\n                    }\r\n                    return [2 /*return*/, responseData.token];\r\n            }\r\n        });\r\n    });\r\n}\r\nfunction requestDeleteToken(firebaseDependencies, token) {\r\n    return __awaiter(this, void 0, void 0, function () {\r\n        var headers, unsubscribeOptions, response, responseData, message, err_3;\r\n        return __generator(this, function (_a) {\r\n            switch (_a.label) {\r\n                case 0: return [4 /*yield*/, getHeaders(firebaseDependencies)];\r\n                case 1:\r\n                    headers = _a.sent();\r\n                    unsubscribeOptions = {\r\n                        method: 'DELETE',\r\n                        headers: headers\r\n                    };\r\n                    _a.label = 2;\r\n                case 2:\r\n                    _a.trys.push([2, 5, , 6]);\r\n                    return [4 /*yield*/, fetch(getEndpoint(firebaseDependencies.appConfig) + \"/\" + token, unsubscribeOptions)];\r\n                case 3:\r\n                    response = _a.sent();\r\n                    return [4 /*yield*/, response.json()];\r\n                case 4:\r\n                    responseData = _a.sent();\r\n                    if (responseData.error) {\r\n                        message = responseData.error.message;\r\n                        throw ERROR_FACTORY.create(\"token-unsubscribe-failed\" /* TOKEN_UNSUBSCRIBE_FAILED */, {\r\n                            errorInfo: message\r\n                        });\r\n                    }\r\n                    return [3 /*break*/, 6];\r\n                case 5:\r\n                    err_3 = _a.sent();\r\n                    throw ERROR_FACTORY.create(\"token-unsubscribe-failed\" /* TOKEN_UNSUBSCRIBE_FAILED */, {\r\n                        errorInfo: err_3\r\n                    });\r\n                case 6: return [2 /*return*/];\r\n            }\r\n        });\r\n    });\r\n}\r\nfunction getEndpoint(_a) {\r\n    var projectId = _a.projectId;\r\n    return ENDPOINT + \"/projects/\" + projectId + \"/registrations\";\r\n}\r\nfunction getHeaders(_a) {\r\n    var appConfig = _a.appConfig, installations = _a.installations;\r\n    return __awaiter(this, void 0, void 0, function () {\r\n        var authToken;\r\n        return __generator(this, function (_b) {\r\n            switch (_b.label) {\r\n                case 0: return [4 /*yield*/, installations.getToken()];\r\n                case 1:\r\n                    authToken = _b.sent();\r\n                    return [2 /*return*/, new Headers({\r\n                            'Content-Type': 'application/json',\r\n                            Accept: 'application/json',\r\n                            'x-goog-api-key': appConfig.apiKey,\r\n                            'x-goog-firebase-installations-auth': \"FIS \" + authToken\r\n                        })];\r\n            }\r\n        });\r\n    });\r\n}\r\nfunction getBody(_a) {\r\n    var p256dh = _a.p256dh, auth = _a.auth, endpoint = _a.endpoint, vapidKey = _a.vapidKey;\r\n    var body = {\r\n        web: {\r\n            endpoint: endpoint,\r\n            auth: auth,\r\n            p256dh: p256dh\r\n        }\r\n    };\r\n    if (vapidKey !== DEFAULT_VAPID_KEY) {\r\n        body.web.applicationPubKey = vapidKey;\r\n    }\r\n    return body;\r\n}\n\n/**\r\n * @license\r\n * Copyright 2019 Google LLC\r\n *\r\n * Licensed under the Apache License, Version 2.0 (the \"License\");\r\n * you may not use this file except in compliance with the License.\r\n * You may obtain a copy of the License at\r\n *\r\n *   http://www.apache.org/licenses/LICENSE-2.0\r\n *\r\n * Unless required by applicable law or agreed to in writing, software\r\n * distributed under the License is distributed on an \"AS IS\" BASIS,\r\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\r\n * See the License for the specific language governing permissions and\r\n * limitations under the License.\r\n */\r\n/** UpdateRegistration will be called once every week. */\r\nvar TOKEN_EXPIRATION_MS = 7 * 24 * 60 * 60 * 1000; // 7 days\r\nfunction getToken(firebaseDependencies, swRegistration, vapidKey) {\r\n    return __awaiter(this, void 0, void 0, function () {\r\n        var pushSubscription, tokenDetails, subscriptionOptions, e_1;\r\n        return __generator(this, function (_a) {\r\n            switch (_a.label) {\r\n                case 0:\r\n                    if (Notification.permission !== 'granted') {\r\n                        throw ERROR_FACTORY.create(\"permission-blocked\" /* PERMISSION_BLOCKED */);\r\n                    }\r\n                    return [4 /*yield*/, getPushSubscription(swRegistration, vapidKey)];\r\n                case 1:\r\n                    pushSubscription = _a.sent();\r\n                    return [4 /*yield*/, dbGet(firebaseDependencies)];\r\n                case 2:\r\n                    tokenDetails = _a.sent();\r\n                    subscriptionOptions = {\r\n                        vapidKey: vapidKey,\r\n                        swScope: swRegistration.scope,\r\n                        endpoint: pushSubscription.endpoint,\r\n                        auth: arrayToBase64(pushSubscription.getKey('auth')),\r\n                        p256dh: arrayToBase64(pushSubscription.getKey('p256dh'))\r\n                    };\r\n                    if (!!tokenDetails) return [3 /*break*/, 3];\r\n                    // No token, get a new one.\r\n                    return [2 /*return*/, getNewToken(firebaseDependencies, subscriptionOptions)];\r\n                case 3:\r\n                    if (!!isTokenValid(tokenDetails.subscriptionOptions, subscriptionOptions)) return [3 /*break*/, 8];\r\n                    _a.label = 4;\r\n                case 4:\r\n                    _a.trys.push([4, 6, , 7]);\r\n                    return [4 /*yield*/, requestDeleteToken(firebaseDependencies, tokenDetails.token)];\r\n                case 5:\r\n                    _a.sent();\r\n                    return [3 /*break*/, 7];\r\n                case 6:\r\n                    e_1 = _a.sent();\r\n                    // Suppress errors because of #2364\r\n                    console.warn(e_1);\r\n                    return [3 /*break*/, 7];\r\n                case 7: return [2 /*return*/, getNewToken(firebaseDependencies, subscriptionOptions)];\r\n                case 8:\r\n                    if (Date.now() >= tokenDetails.createTime + TOKEN_EXPIRATION_MS) {\r\n                        // Weekly token refresh\r\n                        return [2 /*return*/, updateToken({\r\n                                token: tokenDetails.token,\r\n                                createTime: Date.now(),\r\n                                subscriptionOptions: subscriptionOptions\r\n                            }, firebaseDependencies, swRegistration)];\r\n                    }\r\n                    else {\r\n                        // Valid token, nothing to do.\r\n                        return [2 /*return*/, tokenDetails.token];\r\n                    }\r\n                case 9: return [2 /*return*/];\r\n            }\r\n        });\r\n    });\r\n}\r\n/**\r\n * This method deletes the token from the database, unsubscribes the token from FCM, and unregisters\r\n * the push subscription if it exists.\r\n */\r\nfunction deleteToken(firebaseDependencies, swRegistration) {\r\n    return __awaiter(this, void 0, void 0, function () {\r\n        var tokenDetails, pushSubscription;\r\n        return __generator(this, function (_a) {\r\n            switch (_a.label) {\r\n                case 0: return [4 /*yield*/, dbGet(firebaseDependencies)];\r\n                case 1:\r\n                    tokenDetails = _a.sent();\r\n                    if (!tokenDetails) return [3 /*break*/, 4];\r\n                    return [4 /*yield*/, requestDeleteToken(firebaseDependencies, tokenDetails.token)];\r\n                case 2:\r\n                    _a.sent();\r\n                    return [4 /*yield*/, dbRemove(firebaseDependencies)];\r\n                case 3:\r\n                    _a.sent();\r\n                    _a.label = 4;\r\n                case 4: return [4 /*yield*/, swRegistration.pushManager.getSubscription()];\r\n                case 5:\r\n                    pushSubscription = _a.sent();\r\n                    if (pushSubscription) {\r\n                        return [2 /*return*/, pushSubscription.unsubscribe()];\r\n                    }\r\n                    // If there's no SW, consider it a success.\r\n                    return [2 /*return*/, true];\r\n            }\r\n        });\r\n    });\r\n}\r\nfunction updateToken(tokenDetails, firebaseDependencies, swRegistration) {\r\n    return __awaiter(this, void 0, void 0, function () {\r\n        var updatedToken, updatedTokenDetails, e_2;\r\n        return __generator(this, function (_a) {\r\n            switch (_a.label) {\r\n                case 0:\r\n                    _a.trys.push([0, 3, , 5]);\r\n                    return [4 /*yield*/, requestUpdateToken(firebaseDependencies, tokenDetails)];\r\n                case 1:\r\n                    updatedToken = _a.sent();\r\n                    updatedTokenDetails = __assign(__assign({}, tokenDetails), { token: updatedToken, createTime: Date.now() });\r\n                    return [4 /*yield*/, dbSet(firebaseDependencies, updatedTokenDetails)];\r\n                case 2:\r\n                    _a.sent();\r\n                    return [2 /*return*/, updatedToken];\r\n                case 3:\r\n                    e_2 = _a.sent();\r\n                    return [4 /*yield*/, deleteToken(firebaseDependencies, swRegistration)];\r\n                case 4:\r\n                    _a.sent();\r\n                    throw e_2;\r\n                case 5: return [2 /*return*/];\r\n            }\r\n        });\r\n    });\r\n}\r\nfunction getNewToken(firebaseDependencies, subscriptionOptions) {\r\n    return __awaiter(this, void 0, void 0, function () {\r\n        var token, tokenDetails;\r\n        return __generator(this, function (_a) {\r\n            switch (_a.label) {\r\n                case 0: return [4 /*yield*/, requestGetToken(firebaseDependencies, subscriptionOptions)];\r\n                case 1:\r\n                    token = _a.sent();\r\n                    tokenDetails = {\r\n                        token: token,\r\n                        createTime: Date.now(),\r\n                        subscriptionOptions: subscriptionOptions\r\n                    };\r\n                    return [4 /*yield*/, dbSet(firebaseDependencies, tokenDetails)];\r\n                case 2:\r\n                    _a.sent();\r\n                    return [2 /*return*/, tokenDetails.token];\r\n            }\r\n        });\r\n    });\r\n}\r\n/**\r\n * Gets a PushSubscription for the current user.\r\n */\r\nfunction getPushSubscription(swRegistration, vapidKey) {\r\n    return __awaiter(this, void 0, void 0, function () {\r\n        var subscription;\r\n        return __generator(this, function (_a) {\r\n            switch (_a.label) {\r\n                case 0: return [4 /*yield*/, swRegistration.pushManager.getSubscription()];\r\n                case 1:\r\n                    subscription = _a.sent();\r\n                    if (subscription) {\r\n                        return [2 /*return*/, subscription];\r\n                    }\r\n                    return [2 /*return*/, swRegistration.pushManager.subscribe({\r\n                            userVisibleOnly: true,\r\n                            // Chrome <= 75 doesn't support base64-encoded VAPID key. For backward compatibility, VAPID key\r\n                            // submitted to pushManager#subscribe must be of type Uint8Array.\r\n                            applicationServerKey: base64ToArray(vapidKey)\r\n                        })];\r\n            }\r\n        });\r\n    });\r\n}\r\n/**\r\n * Checks if the saved tokenDetails object matches the configuration provided.\r\n */\r\nfunction isTokenValid(dbOptions, currentOptions) {\r\n    var isVapidKeyEqual = currentOptions.vapidKey === dbOptions.vapidKey;\r\n    var isEndpointEqual = currentOptions.endpoint === dbOptions.endpoint;\r\n    var isAuthEqual = currentOptions.auth === dbOptions.auth;\r\n    var isP256dhEqual = currentOptions.p256dh === dbOptions.p256dh;\r\n    return isVapidKeyEqual && isEndpointEqual && isAuthEqual && isP256dhEqual;\r\n}\n\n/**\r\n * @license\r\n * Copyright 2020 Google LLC\r\n *\r\n * Licensed under the Apache License, Version 2.0 (the \"License\");\r\n * you may not use this file except in compliance with the License.\r\n * You may obtain a copy of the License at\r\n *\r\n *   http://www.apache.org/licenses/LICENSE-2.0\r\n *\r\n * Unless required by applicable law or agreed to in writing, software\r\n * distributed under the License is distributed on an \"AS IS\" BASIS,\r\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\r\n * See the License for the specific language governing permissions and\r\n * limitations under the License.\r\n */\r\nfunction externalizePayload(internalPayload) {\r\n    var payload = {\r\n        from: internalPayload.from,\r\n        // eslint-disable-next-line camelcase\r\n        collapseKey: internalPayload.collapse_key,\r\n        // eslint-disable-next-line camelcase\r\n        messageId: internalPayload.fcm_message_id\r\n    };\r\n    propagateNotificationPayload(payload, internalPayload);\r\n    propagateDataPayload(payload, internalPayload);\r\n    propagateFcmOptions(payload, internalPayload);\r\n    return payload;\r\n}\r\nfunction propagateNotificationPayload(payload, messagePayloadInternal) {\r\n    if (!messagePayloadInternal.notification) {\r\n        return;\r\n    }\r\n    payload.notification = {};\r\n    var title = messagePayloadInternal.notification.title;\r\n    if (!!title) {\r\n        payload.notification.title = title;\r\n    }\r\n    var body = messagePayloadInternal.notification.body;\r\n    if (!!body) {\r\n        payload.notification.body = body;\r\n    }\r\n    var image = messagePayloadInternal.notification.image;\r\n    if (!!image) {\r\n        payload.notification.image = image;\r\n    }\r\n}\r\nfunction propagateDataPayload(payload, messagePayloadInternal) {\r\n    if (!messagePayloadInternal.data) {\r\n        return;\r\n    }\r\n    payload.data = messagePayloadInternal.data;\r\n}\r\nfunction propagateFcmOptions(payload, messagePayloadInternal) {\r\n    if (!messagePayloadInternal.fcmOptions) {\r\n        return;\r\n    }\r\n    payload.fcmOptions = {};\r\n    var link = messagePayloadInternal.fcmOptions.link;\r\n    if (!!link) {\r\n        payload.fcmOptions.link = link;\r\n    }\r\n    // eslint-disable-next-line camelcase\r\n    var analyticsLabel = messagePayloadInternal.fcmOptions.analytics_label;\r\n    if (!!analyticsLabel) {\r\n        payload.fcmOptions.analyticsLabel = analyticsLabel;\r\n    }\r\n}\n\n/**\r\n * @license\r\n * Copyright 2019 Google LLC\r\n *\r\n * Licensed under the Apache License, Version 2.0 (the \"License\");\r\n * you may not use this file except in compliance with the License.\r\n * You may obtain a copy of the License at\r\n *\r\n *   http://www.apache.org/licenses/LICENSE-2.0\r\n *\r\n * Unless required by applicable law or agreed to in writing, software\r\n * distributed under the License is distributed on an \"AS IS\" BASIS,\r\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\r\n * See the License for the specific language governing permissions and\r\n * limitations under the License.\r\n */\r\nfunction isConsoleMessage(data) {\r\n    // This message has a campaign ID, meaning it was sent using the Firebase Console.\r\n    return typeof data === 'object' && !!data && CONSOLE_CAMPAIGN_ID in data;\r\n}\n\n/**\r\n * @license\r\n * Copyright 2019 Google LLC\r\n *\r\n * Licensed under the Apache License, Version 2.0 (the \"License\");\r\n * you may not use this file except in compliance with the License.\r\n * You may obtain a copy of the License at\r\n *\r\n *   http://www.apache.org/licenses/LICENSE-2.0\r\n *\r\n * Unless required by applicable law or agreed to in writing, software\r\n * distributed under the License is distributed on an \"AS IS\" BASIS,\r\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\r\n * See the License for the specific language governing permissions and\r\n * limitations under the License.\r\n */\r\n/** Returns a promise that resolves after given time passes. */\r\nfunction sleep(ms) {\r\n    return new Promise(function (resolve) {\r\n        setTimeout(resolve, ms);\r\n    });\r\n}\n\n/**\r\n * @license\r\n * Copyright 2017 Google LLC\r\n *\r\n * Licensed under the Apache License, Version 2.0 (the \"License\");\r\n * you may not use this file except in compliance with the License.\r\n * You may obtain a copy of the License at\r\n *\r\n *   http://www.apache.org/licenses/LICENSE-2.0\r\n *\r\n * Unless required by applicable law or agreed to in writing, software\r\n * distributed under the License is distributed on an \"AS IS\" BASIS,\r\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\r\n * See the License for the specific language governing permissions and\r\n * limitations under the License.\r\n */\r\nvar SwController = /** @class */ (function () {\r\n    function SwController(firebaseDependencies) {\r\n        var _this = this;\r\n        this.firebaseDependencies = firebaseDependencies;\r\n        // A boolean flag to determine wether an app is using onBackgroundMessage or\r\n        // setBackgroundMessageHandler. onBackgroundMessage will receive a MessagePayload regardless of if\r\n        // a notification is displayed. Whereas, setBackgroundMessageHandler will swallow the\r\n        // MessagePayload if a NotificationPayload is included.\r\n        this.isOnBackgroundMessageUsed = null;\r\n        this.vapidKey = null;\r\n        this.bgMessageHandler = null;\r\n        self.addEventListener('push', function (e) {\r\n            e.waitUntil(_this.onPush(e));\r\n        });\r\n        self.addEventListener('pushsubscriptionchange', function (e) {\r\n            e.waitUntil(_this.onSubChange(e));\r\n        });\r\n        self.addEventListener('notificationclick', function (e) {\r\n            e.waitUntil(_this.onNotificationClick(e));\r\n        });\r\n    }\r\n    Object.defineProperty(SwController.prototype, \"app\", {\r\n        get: function () {\r\n            return this.firebaseDependencies.app;\r\n        },\r\n        enumerable: false,\r\n        configurable: true\r\n    });\r\n    /**\r\n     * @deprecated. Use onBackgroundMessage(nextOrObserver: NextFn<object> | Observer<object>):\r\n     * Unsubscribe instead.\r\n     *\r\n     * Calling setBackgroundMessageHandler will opt in to some specific behaviors.\r\n     *\r\n     * 1.) If a notification doesn't need to be shown due to a window already being visible, then push\r\n     * messages will be sent to the page. 2.) If a notification needs to be shown, and the message\r\n     * contains no notification data this method will be called and the promise it returns will be\r\n     * passed to event.waitUntil. If you do not set this callback then all push messages will let and\r\n     * the developer can handle them in a their own 'push' event callback\r\n     *\r\n     * @param callback The callback to be called when a push message is received and a notification\r\n     * must be shown. The callback will be given the data from the push message.\r\n     */\r\n    SwController.prototype.setBackgroundMessageHandler = function (callback) {\r\n        this.isOnBackgroundMessageUsed = false;\r\n        if (!callback || typeof callback !== 'function') {\r\n            throw ERROR_FACTORY.create(\"invalid-bg-handler\" /* INVALID_BG_HANDLER */);\r\n        }\r\n        this.bgMessageHandler = callback;\r\n    };\r\n    SwController.prototype.onBackgroundMessage = function (nextOrObserver) {\r\n        var _this = this;\r\n        this.isOnBackgroundMessageUsed = true;\r\n        this.bgMessageHandler = nextOrObserver;\r\n        return function () {\r\n            _this.bgMessageHandler = null;\r\n        };\r\n    };\r\n    // TODO: Remove getToken from SW Controller. Calling this from an old SW can cause all kinds of\r\n    // trouble.\r\n    SwController.prototype.getToken = function () {\r\n        var _a, _b;\r\n        return __awaiter(this, void 0, void 0, function () {\r\n            var tokenDetails;\r\n            return __generator(this, function (_c) {\r\n                switch (_c.label) {\r\n                    case 0:\r\n                        if (!!this.vapidKey) return [3 /*break*/, 2];\r\n                        return [4 /*yield*/, dbGet(this.firebaseDependencies)];\r\n                    case 1:\r\n                        tokenDetails = _c.sent();\r\n                        this.vapidKey =\r\n                            (_b = (_a = tokenDetails === null || tokenDetails === void 0 ? void 0 : tokenDetails.subscriptionOptions) === null || _a === void 0 ? void 0 : _a.vapidKey) !== null && _b !== void 0 ? _b : DEFAULT_VAPID_KEY;\r\n                        _c.label = 2;\r\n                    case 2: return [2 /*return*/, getToken(this.firebaseDependencies, self.registration, this.vapidKey)];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    // TODO: Remove deleteToken from SW Controller. Calling this from an old SW can cause all kinds of\r\n    // trouble.\r\n    SwController.prototype.deleteToken = function () {\r\n        return deleteToken(this.firebaseDependencies, self.registration);\r\n    };\r\n    SwController.prototype.requestPermission = function () {\r\n        throw ERROR_FACTORY.create(\"only-available-in-window\" /* AVAILABLE_IN_WINDOW */);\r\n    };\r\n    // TODO: Remove this together with getToken from SW Controller.\r\n    SwController.prototype.usePublicVapidKey = function (vapidKey) {\r\n        if (this.vapidKey !== null) {\r\n            throw ERROR_FACTORY.create(\"use-vapid-key-after-get-token\" /* USE_VAPID_KEY_AFTER_GET_TOKEN */);\r\n        }\r\n        if (typeof vapidKey !== 'string' || vapidKey.length === 0) {\r\n            throw ERROR_FACTORY.create(\"invalid-vapid-key\" /* INVALID_VAPID_KEY */);\r\n        }\r\n        this.vapidKey = vapidKey;\r\n    };\r\n    SwController.prototype.useServiceWorker = function () {\r\n        throw ERROR_FACTORY.create(\"only-available-in-window\" /* AVAILABLE_IN_WINDOW */);\r\n    };\r\n    SwController.prototype.onMessage = function () {\r\n        throw ERROR_FACTORY.create(\"only-available-in-window\" /* AVAILABLE_IN_WINDOW */);\r\n    };\r\n    SwController.prototype.onTokenRefresh = function () {\r\n        throw ERROR_FACTORY.create(\"only-available-in-window\" /* AVAILABLE_IN_WINDOW */);\r\n    };\r\n    /**\r\n     * A handler for push events that shows notifications based on the content of the payload.\r\n     *\r\n     * The payload must be a JSON-encoded Object with a `notification` key. The value of the\r\n     * `notification` property will be used as the NotificationOptions object passed to\r\n     * showNotification. Additionally, the `title` property of the notification object will be used as\r\n     * the title.\r\n     *\r\n     * If there is no notification data in the payload then no notification will be shown.\r\n     */\r\n    SwController.prototype.onPush = function (event) {\r\n        return __awaiter(this, void 0, void 0, function () {\r\n            var internalPayload, clientList, isNotificationShown, payload;\r\n            return __generator(this, function (_a) {\r\n                switch (_a.label) {\r\n                    case 0:\r\n                        internalPayload = getMessagePayloadInternal(event);\r\n                        if (!internalPayload) {\r\n                            console.debug(TAG +\r\n                                'failed to get parsed MessagePayload from the PushEvent. Skip handling the push.');\r\n                            return [2 /*return*/];\r\n                        }\r\n                        return [4 /*yield*/, getClientList()];\r\n                    case 1:\r\n                        clientList = _a.sent();\r\n                        if (hasVisibleClients(clientList)) {\r\n                            return [2 /*return*/, sendMessagePayloadInternalToWindows(clientList, internalPayload)];\r\n                        }\r\n                        isNotificationShown = false;\r\n                        if (!!!internalPayload.notification) return [3 /*break*/, 3];\r\n                        return [4 /*yield*/, showNotification(wrapInternalPayload(internalPayload))];\r\n                    case 2:\r\n                        _a.sent();\r\n                        isNotificationShown = true;\r\n                        _a.label = 3;\r\n                    case 3:\r\n                        // MessagePayload is only passed to `onBackgroundMessage`. Skip passing MessagePayload for\r\n                        // the legacy `setBackgroundMessageHandler` to preserve the SDK behaviors.\r\n                        if (isNotificationShown === true &&\r\n                            this.isOnBackgroundMessageUsed === false) {\r\n                            return [2 /*return*/];\r\n                        }\r\n                        if (!!this.bgMessageHandler) {\r\n                            payload = externalizePayload(internalPayload);\r\n                            if (typeof this.bgMessageHandler === 'function') {\r\n                                this.bgMessageHandler(payload);\r\n                            }\r\n                            else {\r\n                                this.bgMessageHandler.next(payload);\r\n                            }\r\n                        }\r\n                        // wait briefly to allow onBackgroundMessage to complete\r\n                        return [4 /*yield*/, sleep(BACKGROUND_HANDLE_EXECUTION_TIME_LIMIT_MS)];\r\n                    case 4:\r\n                        // wait briefly to allow onBackgroundMessage to complete\r\n                        _a.sent();\r\n                        return [2 /*return*/];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    SwController.prototype.onSubChange = function (event) {\r\n        var _a, _b;\r\n        return __awaiter(this, void 0, void 0, function () {\r\n            var newSubscription, tokenDetails;\r\n            return __generator(this, function (_c) {\r\n                switch (_c.label) {\r\n                    case 0:\r\n                        newSubscription = event.newSubscription;\r\n                        if (!!newSubscription) return [3 /*break*/, 2];\r\n                        // Subscription revoked, delete token\r\n                        return [4 /*yield*/, deleteToken(this.firebaseDependencies, self.registration)];\r\n                    case 1:\r\n                        // Subscription revoked, delete token\r\n                        _c.sent();\r\n                        return [2 /*return*/];\r\n                    case 2: return [4 /*yield*/, dbGet(this.firebaseDependencies)];\r\n                    case 3:\r\n                        tokenDetails = _c.sent();\r\n                        return [4 /*yield*/, deleteToken(this.firebaseDependencies, self.registration)];\r\n                    case 4:\r\n                        _c.sent();\r\n                        return [4 /*yield*/, getToken(this.firebaseDependencies, self.registration, (_b = (_a = tokenDetails === null || tokenDetails === void 0 ? void 0 : tokenDetails.subscriptionOptions) === null || _a === void 0 ? void 0 : _a.vapidKey) !== null && _b !== void 0 ? _b : DEFAULT_VAPID_KEY)];\r\n                    case 5:\r\n                        _c.sent();\r\n                        return [2 /*return*/];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    SwController.prototype.onNotificationClick = function (event) {\r\n        var _a, _b;\r\n        return __awaiter(this, void 0, void 0, function () {\r\n            var internalPayload, link, url, originUrl, client;\r\n            return __generator(this, function (_c) {\r\n                switch (_c.label) {\r\n                    case 0:\r\n                        internalPayload = (_b = (_a = event.notification) === null || _a === void 0 ? void 0 : _a.data) === null || _b === void 0 ? void 0 : _b[FCM_MSG];\r\n                        if (!internalPayload) {\r\n                            return [2 /*return*/];\r\n                        }\r\n                        else if (event.action) {\r\n                            // User clicked on an action button. This will allow developers to act on action button clicks\r\n                            // by using a custom onNotificationClick listener that they define.\r\n                            return [2 /*return*/];\r\n                        }\r\n                        // Prevent other listeners from receiving the event\r\n                        event.stopImmediatePropagation();\r\n                        event.notification.close();\r\n                        link = getLink(internalPayload);\r\n                        if (!link) {\r\n                            return [2 /*return*/];\r\n                        }\r\n                        url = new URL(link, self.location.href);\r\n                        originUrl = new URL(self.location.origin);\r\n                        if (url.host !== originUrl.host) {\r\n                            return [2 /*return*/];\r\n                        }\r\n                        return [4 /*yield*/, getWindowClient(url)];\r\n                    case 1:\r\n                        client = _c.sent();\r\n                        if (!!client) return [3 /*break*/, 4];\r\n                        return [4 /*yield*/, self.clients.openWindow(link)];\r\n                    case 2:\r\n                        client = _c.sent();\r\n                        // Wait three seconds for the client to initialize and set up the message handler so that it\r\n                        // can receive the message.\r\n                        return [4 /*yield*/, sleep(FOREGROUND_HANDLE_PREPARATION_TIME_MS)];\r\n                    case 3:\r\n                        // Wait three seconds for the client to initialize and set up the message handler so that it\r\n                        // can receive the message.\r\n                        _c.sent();\r\n                        return [3 /*break*/, 6];\r\n                    case 4: return [4 /*yield*/, client.focus()];\r\n                    case 5:\r\n                        client = _c.sent();\r\n                        _c.label = 6;\r\n                    case 6:\r\n                        if (!client) {\r\n                            // Window Client will not be returned if it's for a third party origin.\r\n                            return [2 /*return*/];\r\n                        }\r\n                        internalPayload.messageType = MessageType.NOTIFICATION_CLICKED;\r\n                        internalPayload.isFirebaseMessaging = true;\r\n                        return [2 /*return*/, client.postMessage(internalPayload)];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    return SwController;\r\n}());\r\nfunction wrapInternalPayload(internalPayload) {\r\n    var _a;\r\n    var wrappedInternalPayload = __assign({}, internalPayload.notification);\r\n    // Put the message payload under FCM_MSG name so we can identify the notification as being an FCM\r\n    // notification vs a notification from somewhere else (i.e. normal web push or developer generated\r\n    // notification).\r\n    wrappedInternalPayload.data = (_a = {},\r\n        _a[FCM_MSG] = internalPayload,\r\n        _a);\r\n    return wrappedInternalPayload;\r\n}\r\nfunction getMessagePayloadInternal(_a) {\r\n    var data = _a.data;\r\n    if (!data) {\r\n        return null;\r\n    }\r\n    try {\r\n        return data.json();\r\n    }\r\n    catch (err) {\r\n        // Not JSON so not an FCM message.\r\n        return null;\r\n    }\r\n}\r\n/**\r\n * @param url The URL to look for when focusing a client.\r\n * @return Returns an existing window client or a newly opened WindowClient.\r\n */\r\nfunction getWindowClient(url) {\r\n    return __awaiter(this, void 0, void 0, function () {\r\n        var clientList, clientList_1, clientList_1_1, client, clientUrl;\r\n        var e_1, _a;\r\n        return __generator(this, function (_b) {\r\n            switch (_b.label) {\r\n                case 0: return [4 /*yield*/, getClientList()];\r\n                case 1:\r\n                    clientList = _b.sent();\r\n                    try {\r\n                        for (clientList_1 = __values(clientList), clientList_1_1 = clientList_1.next(); !clientList_1_1.done; clientList_1_1 = clientList_1.next()) {\r\n                            client = clientList_1_1.value;\r\n                            clientUrl = new URL(client.url, self.location.href);\r\n                            if (url.host === clientUrl.host) {\r\n                                return [2 /*return*/, client];\r\n                            }\r\n                        }\r\n                    }\r\n                    catch (e_1_1) { e_1 = { error: e_1_1 }; }\r\n                    finally {\r\n                        try {\r\n                            if (clientList_1_1 && !clientList_1_1.done && (_a = clientList_1.return)) _a.call(clientList_1);\r\n                        }\r\n                        finally { if (e_1) throw e_1.error; }\r\n                    }\r\n                    return [2 /*return*/, null];\r\n            }\r\n        });\r\n    });\r\n}\r\n/**\r\n * @returns If there is currently a visible WindowClient, this method will resolve to true,\r\n * otherwise false.\r\n */\r\nfunction hasVisibleClients(clientList) {\r\n    return clientList.some(function (client) {\r\n        return client.visibilityState === 'visible' &&\r\n            // Ignore chrome-extension clients as that matches the background pages of extensions, which\r\n            // are always considered visible for some reason.\r\n            !client.url.startsWith('chrome-extension://');\r\n    });\r\n}\r\nfunction sendMessagePayloadInternalToWindows(clientList, internalPayload) {\r\n    var e_2, _a;\r\n    internalPayload.isFirebaseMessaging = true;\r\n    internalPayload.messageType = MessageType.PUSH_RECEIVED;\r\n    try {\r\n        for (var clientList_2 = __values(clientList), clientList_2_1 = clientList_2.next(); !clientList_2_1.done; clientList_2_1 = clientList_2.next()) {\r\n            var client = clientList_2_1.value;\r\n            client.postMessage(internalPayload);\r\n        }\r\n    }\r\n    catch (e_2_1) { e_2 = { error: e_2_1 }; }\r\n    finally {\r\n        try {\r\n            if (clientList_2_1 && !clientList_2_1.done && (_a = clientList_2.return)) _a.call(clientList_2);\r\n        }\r\n        finally { if (e_2) throw e_2.error; }\r\n    }\r\n}\r\nfunction getClientList() {\r\n    return self.clients.matchAll({\r\n        type: 'window',\r\n        includeUncontrolled: true\r\n        // TS doesn't know that \"type: 'window'\" means it'll return WindowClient[]\r\n    });\r\n}\r\nfunction showNotification(notificationPayloadInternal) {\r\n    var _a;\r\n    // Note: Firefox does not support the maxActions property.\r\n    // https://developer.mozilla.org/en-US/docs/Web/API/notification/maxActions\r\n    var actions = notificationPayloadInternal.actions;\r\n    var maxActions = Notification.maxActions;\r\n    if (actions && maxActions && actions.length > maxActions) {\r\n        console.warn(\"This browser only supports \" + maxActions + \" actions. The remaining actions will not be displayed.\");\r\n    }\r\n    return self.registration.showNotification(\r\n    /* title= */ (_a = notificationPayloadInternal.title) !== null && _a !== void 0 ? _a : '', notificationPayloadInternal);\r\n}\r\nfunction getLink(payload) {\r\n    var _a, _b, _c;\r\n    // eslint-disable-next-line camelcase\r\n    var link = (_b = (_a = payload.fcmOptions) === null || _a === void 0 ? void 0 : _a.link) !== null && _b !== void 0 ? _b : (_c = payload.notification) === null || _c === void 0 ? void 0 : _c.click_action;\r\n    if (link) {\r\n        return link;\r\n    }\r\n    if (isConsoleMessage(payload.data)) {\r\n        // Notification created in the Firebase Console. Redirect to origin.\r\n        return self.location.origin;\r\n    }\r\n    else {\r\n        return null;\r\n    }\r\n}\n\n/**\r\n * @license\r\n * Copyright 2017 Google LLC\r\n *\r\n * Licensed under the Apache License, Version 2.0 (the \"License\");\r\n * you may not use this file except in compliance with the License.\r\n * You may obtain a copy of the License at\r\n *\r\n *   http://www.apache.org/licenses/LICENSE-2.0\r\n *\r\n * Unless required by applicable law or agreed to in writing, software\r\n * distributed under the License is distributed on an \"AS IS\" BASIS,\r\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\r\n * See the License for the specific language governing permissions and\r\n * limitations under the License.\r\n */\r\nvar WindowController = /** @class */ (function () {\r\n    function WindowController(firebaseDependencies) {\r\n        var _this = this;\r\n        this.firebaseDependencies = firebaseDependencies;\r\n        this.vapidKey = null;\r\n        this.onMessageCallback = null;\r\n        navigator.serviceWorker.addEventListener('message', function (e) {\r\n            return _this.messageEventListener(e);\r\n        });\r\n    }\r\n    Object.defineProperty(WindowController.prototype, \"app\", {\r\n        get: function () {\r\n            return this.firebaseDependencies.app;\r\n        },\r\n        enumerable: false,\r\n        configurable: true\r\n    });\r\n    WindowController.prototype.messageEventListener = function (event) {\r\n        return __awaiter(this, void 0, void 0, function () {\r\n            var internalPayload, dataPayload;\r\n            return __generator(this, function (_a) {\r\n                switch (_a.label) {\r\n                    case 0:\r\n                        internalPayload = event.data;\r\n                        if (!internalPayload.isFirebaseMessaging) {\r\n                            return [2 /*return*/];\r\n                        }\r\n                        // onMessageCallback is either a function or observer/subscriber.\r\n                        // TODO: in the modularization release, have onMessage handle type MessagePayload as supposed to\r\n                        // the legacy payload where some fields are in snake cases.\r\n                        if (this.onMessageCallback &&\r\n                            internalPayload.messageType === MessageType.PUSH_RECEIVED) {\r\n                            if (typeof this.onMessageCallback === 'function') {\r\n                                this.onMessageCallback(stripInternalFields(Object.assign({}, internalPayload)));\r\n                            }\r\n                            else {\r\n                                this.onMessageCallback.next(Object.assign({}, internalPayload));\r\n                            }\r\n                        }\r\n                        dataPayload = internalPayload.data;\r\n                        if (!(isConsoleMessage(dataPayload) &&\r\n                            dataPayload[CONSOLE_CAMPAIGN_ANALYTICS_ENABLED] === '1')) return [3 /*break*/, 2];\r\n                        return [4 /*yield*/, this.logEvent(internalPayload.messageType, dataPayload)];\r\n                    case 1:\r\n                        _a.sent();\r\n                        _a.label = 2;\r\n                    case 2: return [2 /*return*/];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    WindowController.prototype.getVapidKey = function () {\r\n        return this.vapidKey;\r\n    };\r\n    WindowController.prototype.getSwReg = function () {\r\n        return this.swRegistration;\r\n    };\r\n    WindowController.prototype.getToken = function (options) {\r\n        return __awaiter(this, void 0, void 0, function () {\r\n            return __generator(this, function (_a) {\r\n                switch (_a.label) {\r\n                    case 0:\r\n                        if (!(Notification.permission === 'default')) return [3 /*break*/, 2];\r\n                        return [4 /*yield*/, Notification.requestPermission()];\r\n                    case 1:\r\n                        _a.sent();\r\n                        _a.label = 2;\r\n                    case 2:\r\n                        if (Notification.permission !== 'granted') {\r\n                            throw ERROR_FACTORY.create(\"permission-blocked\" /* PERMISSION_BLOCKED */);\r\n                        }\r\n                        return [4 /*yield*/, this.updateVapidKey(options === null || options === void 0 ? void 0 : options.vapidKey)];\r\n                    case 3:\r\n                        _a.sent();\r\n                        return [4 /*yield*/, this.updateSwReg(options === null || options === void 0 ? void 0 : options.serviceWorkerRegistration)];\r\n                    case 4:\r\n                        _a.sent();\r\n                        return [2 /*return*/, getToken(this.firebaseDependencies, this.swRegistration, this.vapidKey)];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    WindowController.prototype.updateVapidKey = function (vapidKey) {\r\n        return __awaiter(this, void 0, void 0, function () {\r\n            return __generator(this, function (_a) {\r\n                if (!!vapidKey) {\r\n                    this.vapidKey = vapidKey;\r\n                }\r\n                else if (!this.vapidKey) {\r\n                    this.vapidKey = DEFAULT_VAPID_KEY;\r\n                }\r\n                return [2 /*return*/];\r\n            });\r\n        });\r\n    };\r\n    WindowController.prototype.updateSwReg = function (swRegistration) {\r\n        return __awaiter(this, void 0, void 0, function () {\r\n            return __generator(this, function (_a) {\r\n                switch (_a.label) {\r\n                    case 0:\r\n                        if (!(!swRegistration && !this.swRegistration)) return [3 /*break*/, 2];\r\n                        return [4 /*yield*/, this.registerDefaultSw()];\r\n                    case 1:\r\n                        _a.sent();\r\n                        _a.label = 2;\r\n                    case 2:\r\n                        if (!swRegistration && !!this.swRegistration) {\r\n                            return [2 /*return*/];\r\n                        }\r\n                        if (!(swRegistration instanceof ServiceWorkerRegistration)) {\r\n                            throw ERROR_FACTORY.create(\"invalid-sw-registration\" /* INVALID_SW_REGISTRATION */);\r\n                        }\r\n                        this.swRegistration = swRegistration;\r\n                        return [2 /*return*/];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    WindowController.prototype.registerDefaultSw = function () {\r\n        return __awaiter(this, void 0, void 0, function () {\r\n            var _a, e_1;\r\n            return __generator(this, function (_b) {\r\n                switch (_b.label) {\r\n                    case 0:\r\n                        _b.trys.push([0, 2, , 3]);\r\n                        _a = this;\r\n                        return [4 /*yield*/, navigator.serviceWorker.register(DEFAULT_SW_PATH, {\r\n                                scope: DEFAULT_SW_SCOPE\r\n                            })];\r\n                    case 1:\r\n                        _a.swRegistration = _b.sent();\r\n                        // The timing when browser updates sw when sw has an update is unreliable by my experiment. It\r\n                        // leads to version conflict when the SDK upgrades to a newer version in the main page, but sw\r\n                        // is stuck with the old version. For example,\r\n                        // https://github.com/firebase/firebase-js-sdk/issues/2590 The following line reliably updates\r\n                        // sw if there was an update.\r\n                        this.swRegistration.update().catch(function () {\r\n                            /* it is non blocking and we don't care if it failed */\r\n                        });\r\n                        return [3 /*break*/, 3];\r\n                    case 2:\r\n                        e_1 = _b.sent();\r\n                        throw ERROR_FACTORY.create(\"failed-service-worker-registration\" /* FAILED_DEFAULT_REGISTRATION */, {\r\n                            browserErrorMessage: e_1.message\r\n                        });\r\n                    case 3: return [2 /*return*/];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    WindowController.prototype.deleteToken = function () {\r\n        return __awaiter(this, void 0, void 0, function () {\r\n            return __generator(this, function (_a) {\r\n                switch (_a.label) {\r\n                    case 0:\r\n                        if (!!this.swRegistration) return [3 /*break*/, 2];\r\n                        return [4 /*yield*/, this.registerDefaultSw()];\r\n                    case 1:\r\n                        _a.sent();\r\n                        _a.label = 2;\r\n                    case 2: return [2 /*return*/, deleteToken(this.firebaseDependencies, this.swRegistration)];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    /**\r\n     * Request permission if it is not currently granted.\r\n     *\r\n     * @return Resolves if the permission was granted, rejects otherwise.\r\n     *\r\n     * @deprecated Use Notification.requestPermission() instead.\r\n     * https://developer.mozilla.org/en-US/docs/Web/API/Notification/requestPermission\r\n     */\r\n    WindowController.prototype.requestPermission = function () {\r\n        return __awaiter(this, void 0, void 0, function () {\r\n            var permissionResult;\r\n            return __generator(this, function (_a) {\r\n                switch (_a.label) {\r\n                    case 0:\r\n                        if (Notification.permission === 'granted') {\r\n                            return [2 /*return*/];\r\n                        }\r\n                        return [4 /*yield*/, Notification.requestPermission()];\r\n                    case 1:\r\n                        permissionResult = _a.sent();\r\n                        if (permissionResult === 'granted') {\r\n                            return [2 /*return*/];\r\n                        }\r\n                        else if (permissionResult === 'denied') {\r\n                            throw ERROR_FACTORY.create(\"permission-blocked\" /* PERMISSION_BLOCKED */);\r\n                        }\r\n                        else {\r\n                            throw ERROR_FACTORY.create(\"permission-default\" /* PERMISSION_DEFAULT */);\r\n                        }\r\n                }\r\n            });\r\n        });\r\n    };\r\n    /**\r\n     * @deprecated. Use getToken(options?: {vapidKey?: string; serviceWorkerRegistration?:\r\n     * ServiceWorkerRegistration;}): Promise<string> instead.\r\n     */\r\n    WindowController.prototype.usePublicVapidKey = function (vapidKey) {\r\n        if (this.vapidKey !== null) {\r\n            throw ERROR_FACTORY.create(\"use-vapid-key-after-get-token\" /* USE_VAPID_KEY_AFTER_GET_TOKEN */);\r\n        }\r\n        if (typeof vapidKey !== 'string' || vapidKey.length === 0) {\r\n            throw ERROR_FACTORY.create(\"invalid-vapid-key\" /* INVALID_VAPID_KEY */);\r\n        }\r\n        this.vapidKey = vapidKey;\r\n    };\r\n    /**\r\n     * @deprecated. Use getToken(options?: {vapidKey?: string; serviceWorkerRegistration?:\r\n     * ServiceWorkerRegistration;}): Promise<string> instead.\r\n     */\r\n    WindowController.prototype.useServiceWorker = function (swRegistration) {\r\n        if (!(swRegistration instanceof ServiceWorkerRegistration)) {\r\n            throw ERROR_FACTORY.create(\"invalid-sw-registration\" /* INVALID_SW_REGISTRATION */);\r\n        }\r\n        if (this.swRegistration) {\r\n            throw ERROR_FACTORY.create(\"use-sw-after-get-token\" /* USE_SW_AFTER_GET_TOKEN */);\r\n        }\r\n        this.swRegistration = swRegistration;\r\n    };\r\n    /**\r\n     * @param nextOrObserver An observer object or a function triggered on message.\r\n     *\r\n     * @return The unsubscribe function for the observer.\r\n     */\r\n    WindowController.prototype.onMessage = function (nextOrObserver) {\r\n        var _this = this;\r\n        this.onMessageCallback = nextOrObserver;\r\n        return function () {\r\n            _this.onMessageCallback = null;\r\n        };\r\n    };\r\n    WindowController.prototype.setBackgroundMessageHandler = function () {\r\n        throw ERROR_FACTORY.create(\"only-available-in-sw\" /* AVAILABLE_IN_SW */);\r\n    };\r\n    WindowController.prototype.onBackgroundMessage = function () {\r\n        throw ERROR_FACTORY.create(\"only-available-in-sw\" /* AVAILABLE_IN_SW */);\r\n    };\r\n    /**\r\n     * @deprecated No-op. It was initially designed with token rotation requests from server in mind.\r\n     * However, the plan to implement such feature was abandoned.\r\n     */\r\n    WindowController.prototype.onTokenRefresh = function () {\r\n        return function () { };\r\n    };\r\n    WindowController.prototype.logEvent = function (messageType, data) {\r\n        return __awaiter(this, void 0, void 0, function () {\r\n            var eventType, analytics;\r\n            return __generator(this, function (_a) {\r\n                switch (_a.label) {\r\n                    case 0:\r\n                        eventType = getEventType(messageType);\r\n                        return [4 /*yield*/, this.firebaseDependencies.analyticsProvider.get()];\r\n                    case 1:\r\n                        analytics = _a.sent();\r\n                        analytics.logEvent(eventType, {\r\n                            /* eslint-disable camelcase */\r\n                            message_id: data[CONSOLE_CAMPAIGN_ID],\r\n                            message_name: data[CONSOLE_CAMPAIGN_NAME],\r\n                            message_time: data[CONSOLE_CAMPAIGN_TIME],\r\n                            message_device_time: Math.floor(Date.now() / 1000)\r\n                            /* eslint-enable camelcase */\r\n                        });\r\n                        return [2 /*return*/];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    return WindowController;\r\n}());\r\nfunction getEventType(messageType) {\r\n    switch (messageType) {\r\n        case MessageType.NOTIFICATION_CLICKED:\r\n            return 'notification_open';\r\n        case MessageType.PUSH_RECEIVED:\r\n            return 'notification_foreground';\r\n        default:\r\n            throw new Error();\r\n    }\r\n}\r\nfunction stripInternalFields(internalPayload) {\r\n    delete internalPayload.messageType;\r\n    delete internalPayload.isFirebaseMessaging;\r\n    return internalPayload;\r\n}\n\n/**\r\n * @license\r\n * Copyright 2019 Google LLC\r\n *\r\n * Licensed under the Apache License, Version 2.0 (the \"License\");\r\n * you may not use this file except in compliance with the License.\r\n * You may obtain a copy of the License at\r\n *\r\n *   http://www.apache.org/licenses/LICENSE-2.0\r\n *\r\n * Unless required by applicable law or agreed to in writing, software\r\n * distributed under the License is distributed on an \"AS IS\" BASIS,\r\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\r\n * See the License for the specific language governing permissions and\r\n * limitations under the License.\r\n */\r\nfunction extractAppConfig(app) {\r\n    var e_1, _a;\r\n    if (!app || !app.options) {\r\n        throw getMissingValueError('App Configuration Object');\r\n    }\r\n    if (!app.name) {\r\n        throw getMissingValueError('App Name');\r\n    }\r\n    // Required app config keys\r\n    var configKeys = [\r\n        'projectId',\r\n        'apiKey',\r\n        'appId',\r\n        'messagingSenderId'\r\n    ];\r\n    var options = app.options;\r\n    try {\r\n        for (var configKeys_1 = __values(configKeys), configKeys_1_1 = configKeys_1.next(); !configKeys_1_1.done; configKeys_1_1 = configKeys_1.next()) {\r\n            var keyName = configKeys_1_1.value;\r\n            if (!options[keyName]) {\r\n                throw getMissingValueError(keyName);\r\n            }\r\n        }\r\n    }\r\n    catch (e_1_1) { e_1 = { error: e_1_1 }; }\r\n    finally {\r\n        try {\r\n            if (configKeys_1_1 && !configKeys_1_1.done && (_a = configKeys_1.return)) _a.call(configKeys_1);\r\n        }\r\n        finally { if (e_1) throw e_1.error; }\r\n    }\r\n    return {\r\n        appName: app.name,\r\n        projectId: options.projectId,\r\n        apiKey: options.apiKey,\r\n        appId: options.appId,\r\n        senderId: options.messagingSenderId\r\n    };\r\n}\r\nfunction getMissingValueError(valueName) {\r\n    return ERROR_FACTORY.create(\"missing-app-config-values\" /* MISSING_APP_CONFIG_VALUES */, {\r\n        valueName: valueName\r\n    });\r\n}\n\n/**\r\n * @license\r\n * Copyright 2017 Google LLC\r\n *\r\n * Licensed under the Apache License, Version 2.0 (the \"License\");\r\n * you may not use this file except in compliance with the License.\r\n * You may obtain a copy of the License at\r\n *\r\n *   http://www.apache.org/licenses/LICENSE-2.0\r\n *\r\n * Unless required by applicable law or agreed to in writing, software\r\n * distributed under the License is distributed on an \"AS IS\" BASIS,\r\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\r\n * See the License for the specific language governing permissions and\r\n * limitations under the License.\r\n */\r\nvar MESSAGING_NAME = 'messaging';\r\nfunction factoryMethod(container) {\r\n    // Dependencies.\r\n    var app = container.getProvider('app').getImmediate();\r\n    var appConfig = extractAppConfig(app);\r\n    var installations = container.getProvider('installations').getImmediate();\r\n    var analyticsProvider = container.getProvider('analytics-internal');\r\n    var firebaseDependencies = {\r\n        app: app,\r\n        appConfig: appConfig,\r\n        installations: installations,\r\n        analyticsProvider: analyticsProvider\r\n    };\r\n    if (!isSupported()) {\r\n        throw ERROR_FACTORY.create(\"unsupported-browser\" /* UNSUPPORTED_BROWSER */);\r\n    }\r\n    if (self && 'ServiceWorkerGlobalScope' in self) {\r\n        // Running in ServiceWorker context\r\n        return new SwController(firebaseDependencies);\r\n    }\r\n    else {\r\n        // Assume we are in the window context.\r\n        return new WindowController(firebaseDependencies);\r\n    }\r\n}\r\nvar NAMESPACE_EXPORTS = {\r\n    isSupported: isSupported\r\n};\r\nfirebase.INTERNAL.registerComponent(new Component(MESSAGING_NAME, factoryMethod, \"PUBLIC\" /* PUBLIC */).setServiceProps(NAMESPACE_EXPORTS));\r\nfunction isSupported() {\r\n    if (self && 'ServiceWorkerGlobalScope' in self) {\r\n        // Running in ServiceWorker context\r\n        return isSWControllerSupported();\r\n    }\r\n    else {\r\n        // Assume we are in the window context.\r\n        return isWindowControllerSupported();\r\n    }\r\n}\r\n/**\r\n * Checks to see if the required APIs exist.\r\n */\r\nfunction isWindowControllerSupported() {\r\n    return ('indexedDB' in window &&\r\n        indexedDB !== null &&\r\n        navigator.cookieEnabled &&\r\n        'serviceWorker' in navigator &&\r\n        'PushManager' in window &&\r\n        'Notification' in window &&\r\n        'fetch' in window &&\r\n        ServiceWorkerRegistration.prototype.hasOwnProperty('showNotification') &&\r\n        PushSubscription.prototype.hasOwnProperty('getKey'));\r\n}\r\n/**\r\n * Checks to see if the required APIs exist within SW Context.\r\n */\r\nfunction isSWControllerSupported() {\r\n    return ('indexedDB' in self &&\r\n        indexedDB !== null &&\r\n        'PushManager' in self &&\r\n        'Notification' in self &&\r\n        ServiceWorkerRegistration.prototype.hasOwnProperty('showNotification') &&\r\n        PushSubscription.prototype.hasOwnProperty('getKey'));\r\n}\n"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}